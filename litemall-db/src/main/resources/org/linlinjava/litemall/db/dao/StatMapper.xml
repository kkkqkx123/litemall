<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.linlinjava.litemall.db.dao.StatMapper">
    <select id="statUser" resultType="map">
        select
        substr(add_time,1,10) as day,
        count(distinct id) as users
        from litemall_user
        group by substr(add_time,1,10)
    </select>
    
    <!-- 原始订单统计查询 -->
    <select id="statOrder" resultType="map">
        select
        substr(add_time,1,10) as day,
        count(id) as orders,
        count(distinct user_id) as customers,
        sum(actual_price) as amount,
        round(sum(actual_price)/count(distinct user_id),2) as pcr
        from litemall_order
        where order_status in(401,402)
        group by substr(add_time,1,10)
    </select>
    
    <!-- 增强版订单统计查询，支持时间维度和商品类别筛选 -->
    <select id="statOrderEnhanced" resultType="map">
        select
        <choose>
            <when test="timeDimension == 'day'">substr(o.add_time,1,10)</when>
            <when test="timeDimension == 'week'">date_format(o.add_time,'%Y-%u')</when>
            <when test="timeDimension == 'month'">substr(o.add_time,1,7)</when>
            <otherwise>substr(o.add_time,1,10)</otherwise>
        </choose> as period,
        count(o.id) as orders,
        count(distinct o.user_id) as customers,
        sum(o.actual_price) as amount,
        round(sum(o.actual_price)/count(distinct o.user_id),2) as pcr
        from litemall_order o
        left join litemall_order_goods og on o.id = og.order_id
        left join litemall_goods g on og.goods_id = g.id
        where o.order_status in(401,402)
        <if test="categoryId != null">
            and g.category_id = #{categoryId}
        </if>
        group by period
        order by period
    </select>
    
    <select id="statGoods" resultType="map">
        select
        substr(add_time,1, 10) as day,
        count(distinct order_id) as orders,
        sum(number) as products,
        sum(number*price) as amount
        from litemall_order_goods
        group by substr(add_time,1, 10)
    </select>
</mapper>
