# 系统架构图

## 整体架构图

### 1. 系统架构总览

```mermaid
graph TB
    subgraph "前端层"
        A1[管理后台<br/>litemall-admin]
        A2[移动端H5<br/>litemall-vue]
        A3[微信小程序<br/>litemall-wx]
        A4[备用小程序<br/>renard-wx]
    end
    
    subgraph "负载均衡层"
        LB[Nginx<br/>负载均衡/静态资源]
    end
    
    subgraph "网关层"
        GW[API网关<br/>路由/限流/认证]
    end
    
    subgraph "业务服务层"
        S1[litemall-wx-api<br/>小程序API服务]
        S2[litemall-admin-api<br/>管理后台API服务]
        S3[litemall-all<br/>聚合服务]
    end
    
    subgraph "核心服务层"
        C1[litemall-core<br/>核心业务服务]
        C2[litemall-db<br/>数据访问层]
    end
    
    subgraph "数据层"
        DB[(MySQL<br/>主数据库)]
        CACHE[(Redis<br/>缓存)]
        MQ[RabbitMQ<br/>消息队列]
    end
    
    subgraph "第三方服务"
        WX[微信服务<br/>登录/支付]
        OSS[阿里云OSS<br/>文件存储]
        SMS[腾讯云SMS<br/>短信服务]
    end
    
    A1 --> LB
    A2 --> LB
    A3 --> LB
    A4 --> LB
    
    LB --> GW
    GW --> S1
    GW --> S2
    GW --> S3
    
    S1 --> C1
    S2 --> C1
    S3 --> C1
    
    C1 --> C2
    C2 --> DB
    C1 --> CACHE
    C1 --> MQ
    
    C1 --> WX
    C1 --> OSS
    C1 --> SMS
```

### 2. 模块依赖关系图

```mermaid
graph TD
    subgraph "litemall父项目"
        M1[litemall-core<br/>核心模块]
        M2[litemall-db<br/>数据模块]
        M3[litemall-wx-api<br/>小程序API]
        M4[litemall-admin-api<br/>管理API]
        M5[litemall-all<br/>聚合服务]
        M6[litemall-all-war<br/>WAR包]
    end
    
    M1 -.->|依赖| M2
    M3 -.->|依赖| M1
    M3 -.->|依赖| M2
    M4 -.->|依赖| M1
    M4 -.->|依赖| M2
    M5 -.->|依赖| M1
    M5 -.->|依赖| M2
    M5 -.->|依赖| M3
    M5 -.->|依赖| M4
    M6 -.->|依赖| M5
```

### 3. 数据流架构图

```mermaid
sequenceDiagram
    participant 用户
    participant 前端
    participant Nginx
    participant API网关
    participant 业务服务
    participant 核心服务
    participant 数据访问
    participant 数据库
    
    用户->>前端: 发起请求
    前端->>Nginx: HTTP请求
    Nginx->>API网关: 路由转发
    API网关->>业务服务: 业务请求
    业务服务->>核心服务: 调用核心逻辑
    核心服务->>数据访问: 数据操作
    数据访问->>数据库: SQL执行
    数据库-->>数据访问: 返回结果
    数据访问-->>核心服务: 数据对象
    核心服务-->>业务服务: 业务结果
    业务服务-->>API网关: 响应数据
    API网关-->>Nginx: 返回响应
    Nginx-->>前端: HTTP响应
    前端-->>用户: 页面更新
```

### 4. 部署架构图

#### 4.1 单体部署架构

```mermaid
graph LR
    subgraph "用户端"
        U[用户浏览器]
    end
    
    subgraph "服务器端"
        N[Nginx<br/>80/443端口]
        APP[Spring Boot<br/>litemall-all.jar<br/>8080端口]
        DB[(MySQL<br/>3306端口)]
    end
    
    U -->|HTTP/HTTPS| N
    N -->|代理| APP
    APP -->|JDBC| DB
```

#### 4.2 分布式部署架构

```mermaid
graph TB
    subgraph "用户层"
        PC[PC浏览器]
        Mobile[移动端浏览器]
        MiniApp[微信小程序]
    end
    
    subgraph "CDN层"
        CDN[CDN节点<br/>静态资源加速]
    end
    
    subgraph "负载均衡层"
        HA[高可用Nginx<br/>主备模式]
    end
    
    subgraph "应用服务层"
        APP1[应用服务器1<br/>litemall-wx-api]
        APP2[应用服务器2<br/>litemall-admin-api]
        APP3[应用服务器3<br/>litemall-all]
    end
    
    subgraph "数据层"
        Master[(MySQL主库<br/>读写)]
        Slave[(MySQL从库<br/>只读)]
        Redis[(Redis集群<br/>缓存)]
    end
    
    PC --> CDN
    Mobile --> CDN
    MiniApp --> HA
    
    CDN --> HA
    HA --> APP1
    HA --> APP2
    HA --> APP3
    
    APP1 --> Master
    APP1 --> Slave
    APP1 --> Redis
    
    APP2 --> Master
    APP2 --> Slave
    APP2 --> Redis
    
    APP3 --> Master
    APP3 --> Slave
    APP3 --> Redis
    
    Master -.复制.-> Slave
```

### 5. 微服务架构演进图

```mermaid
graph LR
    subgraph "阶段1: 单体架构"
        Mono[单体应用<br/>litemall-all.jar]
        DB1[(MySQL)]
        Mono --> DB1
    end
    
    subgraph "阶段2: 垂直拆分"
        API1[小程序API服务]
        API2[管理后台API]
        Core[核心服务]
        DB2[(MySQL)]
        Cache[(Redis)]
        
        API1 --> Core
        API2 --> Core
        Core --> DB2
        Core --> Cache
    end
    
    subgraph "阶段3: 微服务架构"
        User[用户服务]
        Goods[商品服务]
        Order[订单服务]
        Payment[支付服务]
        Gateway[API网关]
        
        UserDB[(用户DB)]
        GoodsDB[(商品DB)]
        OrderDB[(订单DB)]
        
        Gateway --> User
        Gateway --> Goods
        Gateway --> Order
        Gateway --> Payment
        
        User --> UserDB
        Goods --> GoodsDB
        Order --> OrderDB
    end
    
    Mono -.->|演进| API1
    API1 -.->|演进| Gateway
```

### 6. 安全架构图

```mermaid
graph TB
    subgraph "安全层"
        WAF[Web应用防火墙]
        SSL[SSL/TLS加密]
        AUTH[认证授权]
    end
    
    subgraph "应用安全"
        JWT[JWT Token]
        SpringSecurity[Spring Security权限控制]
        RateLimit[限流控制]
    end
    
    subgraph "数据安全"
        Encrypt[数据加密]
        Backup[数据备份]
        Audit[审计日志]
    end
    
    subgraph "基础设施安全"
        FW[防火墙]
        VPN[VPN访问]
        IDS[入侵检测]
    end
    
    WAF --> SSL
    SSL --> AUTH
    AUTH --> JWT
    JWT --> SpringSecurity
    SpringSecurity --> RateLimit
    RateLimit --> Encrypt
    Encrypt --> Backup
    Backup --> Audit
    
    FW --> VPN
    VPN --> IDS
```

### 7. 缓存架构图

```mermaid
graph TB
    subgraph "缓存层级"
        CDN[CDN缓存<br/>静态资源]
        Browser[浏览器缓存<br/>客户端]
        Redis[Redis缓存<br/>应用级]
        MyBatis[MyBatis缓存<br/>ORM级]
    end
    
    subgraph "缓存策略"
        Cache1[商品列表缓存<br/>TTL: 5分钟]
        Cache2[商品详情缓存<br/>TTL: 30分钟]
        Cache3[用户会话缓存<br/>TTL: 2小时]
        Cache4[系统配置缓存<br/>TTL: 1天]
    end
    
    subgraph "缓存更新"
        Invalidate[缓存失效]
        Update[缓存更新]
        Sync[缓存同步]
    end
    
    CDN --> Browser
    Browser --> Redis
    Redis --> MyBatis
    
    Cache1 --> Invalidate
    Cache2 --> Update
    Cache3 --> Sync
    Cache4 --> Invalidate
```

### 8. 监控架构图

```mermaid
graph TB
    subgraph "应用监控"
        Metrics[应用指标<br/>Spring Boot Actuator]
        Health[健康检查]
        Perf[性能监控]
    end
    
    subgraph "系统监控"
        Server[服务器监控<br/>CPU/内存/磁盘]
        DB[数据库监控<br/>连接/查询/慢查询]
        Net[网络监控<br/>流量/延迟]
    end
    
    subgraph "业务监控"
        Order[订单监控<br/>创建/支付/完成]
        User[用户监控<br/>注册/登录/活跃]
        Goods[商品监控<br/>浏览/收藏/购买]
    end
    
    subgraph "告警系统"
        Alert[告警规则]
        Notify[通知机制]
        Report[报表生成]
    end
    
    Metrics --> Health
    Health --> Perf
    Perf --> Server
    
    Server --> DB
    DB --> Net
    Net --> Order
    
    Order --> User
    User --> Goods
    Goods --> Alert
    Alert --> Notify
    Notify --> Report
```

### 9. 容器化部署架构

```mermaid
graph TB
    subgraph "容器编排"
        K8S[Kubernetes集群]
        Ingress[Ingress控制器]
        Service[Service负载均衡]
    end
    
    subgraph "容器化应用"
        Pod1[litemall-wx-api<br/>Pod]
        Pod2[litemall-admin-api<br/>Pod]
        Pod3[litemall-all<br/>Pod]
        Pod4[MySQL<br/>Pod]
        Pod5[Redis<br/>Pod]
    end
    
    subgraph "存储卷"
        PVC1[MySQL数据卷]
        PVC2[应用日志卷]
        PVC3[文件存储卷]
    end
    
    Ingress --> Service
    Service --> Pod1
    Service --> Pod2
    Service --> Pod3
    
    Pod1 --> Pod4
    Pod1 --> Pod5
    
    Pod4 --> PVC1
    Pod1 --> PVC2
    Pod1 --> PVC3
```

### 10. 灾备架构图

```mermaid
graph TB
    subgraph "主数据中心"
        Master[主应用集群]
        MasterDB[(主数据库)]
        MasterCache[(主Redis)]
    end
    
    subgraph "备份数据中心"
        Backup[备份应用集群]
        BackupDB[(备份数据库)]
        BackupCache[(备份Redis)]
    end
    
    subgraph "数据同步"
        Sync[实时数据同步]
        BackupJob[定时备份任务]
        Restore[灾难恢复机制]
    end
    
    subgraph "监控告警"
        Monitor[健康监控]
        Alert[故障告警]
        Switch[自动切换]
    end
    
    Master --> MasterDB
    Master --> MasterCache
    
    MasterDB -.同步.-> BackupDB
    MasterCache -.同步.-> BackupCache
    
    Backup --> BackupDB
    Backup --> BackupCache
    
    Monitor --> Master
    Monitor --> Backup
    Alert --> Switch
    Switch --> Backup
```

## 架构演进路线

### 当前架构（单体架构）
- **特点**：简单、易部署、开发效率高
- **适用场景**：中小型项目、团队规模较小
- **技术栈**：Spring Boot单体应用

### 阶段一：垂直拆分
- **目标**：按业务领域拆分
- **拆分方式**：小程序API、管理后台API、聚合服务
- **预期收益**：提高可维护性、降低耦合度

### 阶段二：微服务架构
- **目标**：服务化改造
- **拆分方式**：用户服务、商品服务、订单服务、支付服务
- **预期收益**：独立部署、弹性伸缩、技术栈多样化

### 阶段三：云原生架构
- **目标**：容器化、服务网格
- **技术栈**：Kubernetes、Service Mesh、Serverless
- **预期收益**：自动扩缩容、高可用、成本优化

## 架构决策记录

### ADR-001：技术栈选择
- **决策**：Spring Boot + MyBatis + MySQL
- **理由**：
  - 团队熟悉度高
  - 社区支持好
  - 生态丰富
  - 学习成本低

### ADR-002：数据库选择
- **决策**：MySQL 8.x
- **理由**：
  - 开源免费
  - 性能优秀
  - 主从复制成熟
  - 云厂商支持好

### ADR-003：缓存策略
- **决策**：Redis + 本地缓存
- **理由**：
  - 读写性能高
  - 支持多种数据结构
  - 持久化支持
  - 集群方案成熟

### ADR-004：部署策略
- **决策**：单体优先，支持分布式
- **理由**：
  - 快速交付
  - 运维简单
  - 成本可控
  - 易于扩展

这些架构图展示了litemall项目从单体应用到分布式系统的完整技术架构，为项目的演进和扩展提供了清晰的路线图。