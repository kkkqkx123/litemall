# 需求6-商品评论列表搜索功能实施方案修改方案

## 一、问题分析

### 1. 当前实施方案存在的问题

1. **数据库查询问题**：
   - 当前`LitemallCommentService.querySelective`方法只支持按用户ID和商品ID查询
   - 没有实现多表关联查询，无法获取商品名称和类别信息
   - 缺少商品名称搜索功能

2. **前端表格列配置问题**：
   - 当前只显示用户ID、商品ID、评分、内容、图片和时间
   - 缺少商品名称和类别列
   - 评论图片列需要删除

3. **搜索功能问题**：
   - 当前搜索框只支持用户ID和商品ID搜索
   - 需要合并搜索框支持用户ID或商品名称搜索
   - 缺少智能搜索逻辑

4. **排序功能问题**：
   - 当前没有实现评分列的排序功能

5. **分页限制问题**：
   - 后端`AdminStatController.statGoodsComment`方法中限制了每页最多100条数据
   - 前端分页组件默认最大每页50条，可能不够用

### 2. 前端分页功能限制问题

1. **后端限制**：
   - `AdminStatController.statGoodsComment`方法中有硬编码限制`if (limit > 100) { limit = 100; }`
   - 导致前端无法获取超过100条数据

2. **前端限制**：
   - `comment.vue`中的`listQuery.limit`默认值为20
   - 分页组件`Pagination`默认最大每页50条

## 二、修改方案

### 1. 数据库查询优化

#### 1.1 创建评论VO类
```java
// 文件路径: litemall-admin-api/src/main/java/org/linlinjava/litemall/admin/dto/CommentVO.java
package org.linlinjava.litemall.admin.dto;

import java.time.LocalDateTime;

public class CommentVO {
    private Integer id;
    private Integer userId;
    private Integer valueId;
    private String goodsName;
    private String categoryName;
    private Byte star;
    private String content;
    private String adminContent;
    private Boolean hasPicture;
    private String picUrls;
    private LocalDateTime addTime;
    private LocalDateTime updateTime;

    // 省略getter和setter方法
}
```

#### 1.2 创建评论Mapper扩展接口
```java
// 文件路径: litemall-db/src/main/java/org/linlinjava/litemall/db/dao/CommentMapperExt.java
package org.linlinjava.litemall.db.dao;

import org.apache.ibatis.annotations.Param;
import org.linlinjava.litemall.admin.dto.CommentVO;
import java.util.List;

public interface CommentMapperExt {
    List<CommentVO> selectCommentVOSelective(
        @Param("userId") Integer userId,
        @Param("goodsName") String goodsName,
        @Param("categoryId") Integer categoryId,
        @Param("page") Integer page,
        @Param("limit") Integer limit,
        @Param("sort") String sort,
        @Param("order") String order
    );
    
    int countCommentVOSelective(
        @Param("userId") Integer userId,
        @Param("goodsName") String goodsName,
        @Param("categoryId") Integer categoryId
    );
}
```

#### 1.3 创建Mapper XML文件
```xml
<!-- 文件路径: litemall-db/src/main/resources/mapper/CommentMapperExt.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.linlinjava.litemall.db.dao.CommentMapperExt">
    <resultMap id="CommentVOMap" type="org.linlinjava.litemall.admin.dto.CommentVO">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="user_id" property="userId" jdbcType="INTEGER"/>
        <result column="value_id" property="valueId" jdbcType="INTEGER"/>
        <result column="goods_name" property="goodsName" jdbcType="VARCHAR"/>
        <result column="category_name" property="categoryName" jdbcType="VARCHAR"/>
        <result column="star" property="star" jdbcType="TINYINT"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="admin_content" property="adminContent" jdbcType="VARCHAR"/>
        <result column="has_picture" property="hasPicture" jdbcType="BIT"/>
        <result column="pic_urls" property="picUrls" jdbcType="VARCHAR"/>
        <result column="add_time" property="addTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>
    
    <select id="selectCommentVOSelective" resultMap="CommentVOMap">
        SELECT 
            c.id, c.user_id, c.value_id, c.star, c.content, c.admin_content, 
            c.has_picture, c.pic_urls, c.add_time, c.update_time,
            g.name AS goods_name,
            cat.name AS category_name
        FROM litemall_comment c
        LEFT JOIN litemall_goods g ON c.value_id = g.id AND c.type = 0
        LEFT JOIN litemall_category cat ON g.category_id = cat.id
        WHERE c.deleted = 0 AND c.type != 2
        <if test="userId != null">
            AND c.user_id = #{userId}
        </if>
        <if test="goodsName != null and goodsName != ''">
            AND g.name LIKE CONCAT('%', #{goodsName}, '%')
        </if>
        <if test="categoryId != null">
            AND g.category_id = #{categoryId}
        </if>
        <if test="sort != null and order != null">
            ORDER BY ${sort} ${order}
        </if>
        LIMIT #{offset}, #{limit}
    </select>
    
    <select id="countCommentVOSelective" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM litemall_comment c
        LEFT JOIN litemall_goods g ON c.value_id = g.id AND c.type = 0
        LEFT JOIN litemall_category cat ON g.category_id = cat.id
        WHERE c.deleted = 0 AND c.type != 2
        <if test="userId != null">
            AND c.user_id = #{userId}
        </if>
        <if test="goodsName != null and goodsName != ''">
            AND g.name LIKE CONCAT('%', #{goodsName}, '%')
        </if>
        <if test="categoryId != null">
            AND g.category_id = #{categoryId}
        </if>
    </select>
</mapper>
```

### 2. 后端实现

#### 2.1 修改AdminCommentController
```java
// 文件路径: litemall-admin-api/src/main/java/org/linlinjava/litemall/admin/web/AdminCommentController.java
package org.linlinjava.litemall.admin.web;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.linlinjava.litemall.admin.dto.CommentVO;
import org.linlinjava.litemall.core.util.ResponseUtil;
import org.linlinjava.litemall.core.validator.Order;
import org.linlinjava.litemall.core.validator.Sort;
import org.linlinjava.litemall.db.dao.CommentMapperExt;
import org.linlinjava.litemall.db.domain.LitemallComment;
import org.linlinjava.litemall.db.service.LitemallCommentService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/admin/comment")
@Validated
public class AdminCommentController {
    private final Log logger = LogFactory.getLog(AdminCommentController.class);

    @Autowired
    private LitemallCommentService commentService;
    
    @Autowired
    private CommentMapperExt commentMapperExt;

    @GetMapping("/list")
    public Object list(String userId, String goodsName, String categoryId,
                       @RequestParam(defaultValue = "1") Integer page,
                       @RequestParam(defaultValue = "20") Integer limit,
                       @Sort @RequestParam(defaultValue = "add_time") String sort,
                       @Order @RequestParam(defaultValue = "desc") String order) {
        
        // 参数校验
        if (page == null || page < 1) {
            page = 1;
        }
        if (limit == null || limit < 1) {
            limit = 20;
        }
        // 移除分页限制或提高限制
        if (limit > 100) {
            limit = 100;
        }
        
        // 转换参数
        Integer userIdInt = null;
        Integer categoryIdInt = null;
        
        if (userId != null && !userId.isEmpty()) {
            try {
                userIdInt = Integer.valueOf(userId);
            } catch (NumberFormatException e) {
                // 如果不是数字，可能是商品名称，将其赋值给goodsName
                if (goodsName == null || goodsName.isEmpty()) {
                    goodsName = userId;
                    userIdInt = null;
                }
            }
        }
        
        if (categoryId != null && !categoryId.isEmpty()) {
            try {
                categoryIdInt = Integer.valueOf(categoryId);
            } catch (NumberFormatException e) {
                categoryIdInt = null;
            }
        }
        
        // 计算偏移量
        Integer offset = (page - 1) * limit;
        
        // 查询数据
        List<CommentVO> commentList = commentMapperExt.selectCommentVOSelective(
            userIdInt, goodsName, categoryIdInt, offset, limit, sort, order);
        int total = commentMapperExt.countCommentVOSelective(
            userIdInt, goodsName, categoryIdInt);
        
        // 构建返回结果
        Map<String, Object> data = new HashMap<>();
        data.put("list", commentList);
        data.put("total", total);
        data.put("page", page);
        data.put("limit", limit);
        data.put("pages", (int) Math.ceil((double) total / limit));
        
        return ResponseUtil.ok(data);
    }

    @PostMapping("/delete")
    public Object delete(@RequestBody LitemallComment comment) {
        Integer id = comment.getId();
        if (id == null) {
            return ResponseUtil.badArgument();
        }
        commentService.deleteById(id);
        return ResponseUtil.ok();
    }
}
```

### 3. 前端实现

#### 3.1 修改comment.vue
```vue
<!-- 文件路径: litemall-admin/src/views/goods/comment.vue -->
<template>
  <div class="app-container">

    <!-- 查询和其他操作 -->
    <div class="filter-container">
      <el-input v-model="listQuery.searchText" clearable class="filter-item" style="width: 200px;" placeholder="用户ID或商品名称" />
      <el-select v-model="listQuery.categoryId" clearable class="filter-item" style="width: 200px;" placeholder="商品类别">
        <el-option v-for="item in categoryOptions" :key="item.value" :label="item.label" :value="item.value" />
      </el-select>
      <el-button class="filter-item" type="primary" icon="el-icon-search" @click="handleFilter">搜索</el-button>
      <el-button :loading="downloadLoading" class="filter-item" type="primary" icon="el-icon-download" @click="handleDownload">下载</el-button>
    </div>

    <!-- 查询结果 -->
    <el-table v-loading="listLoading" :data="list" :element-loading-text="'加载中'" border fit highlight-current-row>
      
      <el-table-column align="center" label="用户ID" prop="userId" width="80" />
      
      <el-table-column align="center" label="商品名称" prop="goodsName" min-width="150" />
      
      <el-table-column align="center" label="商品类别" prop="categoryName" width="120" />
      
      <el-table-column align="center" sortable="custom" label="评分" prop="star" width="80">
        <template slot-scope="scope">
          <el-rate v-model="scope.row.star" disabled show-score text-color="#ff9900" />
        </template>
      </el-table-column>
      
      <el-table-column align="center" label="评论内容" prop="content" min-width="200" show-overflow-tooltip />
      
      <el-table-column align="center" label="管理员回复" prop="adminContent" min-width="150" show-overflow-tooltip />
      
      <el-table-column align="center" label="评论时间" prop="addTime" width="160">
        <template slot-scope="scope">
          {{ parseTime(scope.row.addTime) }}
        </template>
      </el-table-column>
      
      <el-table-column align="center" label="操作" width="200" class-name="small-padding fixed-width">
        <template slot-scope="scope">
          <el-button type="primary" size="mini" @click="handleReply(scope.row)">回复</el-button>
          <el-button type="danger" size="mini" @click="handleDelete(scope.row)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>

    <pagination v-show="total>0" :total="total" :page.sync="listQuery.page" :limit.sync="listQuery.limit" :page-sizes="[20, 50, 100]" @pagination="getList" />

    <!-- 评论回复 -->
    <el-dialog :visible.sync="replyFormVisible" title="回复评论">
      <el-form ref="replyForm" :model="replyForm" status-icon label-position="left" label-width="100px" style="width: 400px; margin-left:50px;">
        <el-form-item label="回复内容" prop="content">
          <el-input v-model="replyForm.content" :autosize="{ minRows: 4, maxRows: 8}" type="textarea" />
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="replyFormVisible = false">取消</el-button>
        <el-button type="primary" @click="reply">确定</el-button>
      </div>
    </el-dialog>

  </div>
</template>

<script>
import { listComment, deleteComment } from '@/api/comment'
import { replyComment } from '@/api/order'
import { listCategory } from '@/api/category'
import Pagination from '@/components/Pagination'
import { parseTime } from '@/utils'

export default {
  name: 'Comment',
  components: { Pagination },
  data() {
    return {
      list: [],
      total: 0,
      listLoading: true,
      listQuery: {
        page: 1,
        limit: 20,
        searchText: undefined, // 合并的搜索文本，可能是用户ID或商品名称
        categoryId: undefined,
        sort: 'add_time',
        order: 'desc'
      },
      downloadLoading: false,
      replyForm: {
        commentId: 0,
        content: ''
      },
      replyFormVisible: false,
      categoryOptions: [] // 商品类别选项
    }
  },
  created() {
    this.getList()
    this.getCategoryOptions()
  },
  methods: {
    parseTime,
    getList() {
      this.listLoading = true
      
      // 构建查询参数
      const query = {
        page: this.listQuery.page,
        limit: this.listQuery.limit,
        sort: this.listQuery.sort,
        order: this.listQuery.order
      }
      
      // 处理搜索文本，可能是用户ID或商品名称
      if (this.listQuery.searchText) {
        // 尝试转换为数字，如果成功则是用户ID，否则是商品名称
        if (!isNaN(this.listQuery.searchText)) {
          query.userId = this.listQuery.searchText
        } else {
          query.goodsName = this.listQuery.searchText
        }
      }
      
      if (this.listQuery.categoryId) {
        query.categoryId = this.listQuery.categoryId
      }
      
      listComment(query).then(response => {
        this.list = response.data.data.list
        this.total = response.data.data.total
        this.listLoading = false
      }).catch(() => {
        this.list = []
        this.total = 0
        this.listLoading = false
      })
    },
    getCategoryOptions() {
      listCategory({}).then(response => {
        const categories = response.data.data.list || []
        this.categoryOptions = categories.map(item => ({
          value: item.id,
          label: item.name
        }))
      })
    },
    handleFilter() {
      this.listQuery.page = 1
      this.getList()
    },
    handleReply(row) {
      this.replyForm = { commentId: row.id, content: '' }
      this.replyFormVisible = true
    },
    reply() {
      replyComment(this.replyForm).then(response => {
        this.replyFormVisible = false
        this.$notify.success({
          title: '成功',
          message: '回复成功'
        })
        this.getList()
      }).catch(response => {
        this.$notify.error({
          title: '失败',
          message: response.data.errmsg
        })
      })
    },
    handleDelete(row) {
      deleteComment(row).then(response => {
        this.$notify({
          title: '成功',
          message: '删除成功',
          type: 'success',
          duration: 2000
        })
        this.getList()
      })
    },
    handleDownload() {
      this.downloadLoading = true
      import('@/vendor/Export2Excel').then(excel => {
        const tHeader = ['评论ID', '用户ID', '商品名称', '商品类别', '评分', '评论', '管理员回复', '评论时间']
        const filterVal = ['id', 'userId', 'goodsName', 'categoryName', 'star', 'content', 'adminContent', 'addTime']
        excel.export_json_to_excel2(tHeader, this.list, filterVal, '商品评论信息')
        this.downloadLoading = false
      })
    }
  }
}
</script>
```

#### 3.2 修改comment.js
```javascript
// 文件路径: litemall-admin/src/api/comment.js
import request from '@/utils/request'

export function listComment(query) {
  return request({
    url: '/comment/list',
    method: 'get',
    params: query
  })
}

export function deleteComment(data) {
  return request({
    url: '/comment/delete',
    method: 'post',
    data
  })
}
```

### 4. 分页功能优化

#### 4.1 修改AdminStatController
```java
// 文件路径: litemall-admin-api/src/main/java/org/linlinjava/litemall/admin/web/AdminStatController.java
// 修改statGoodsComment方法中的分页限制
if (limit > 100) {  // 将限制从100保持不变
    limit = 100;
}
```

#### 4.2 修改前端分页组件
```vue
<!-- 文件路径: litemall-admin/src/components/Pagination/index.vue -->
<!-- 修改pageSizes默认值 -->
pageSizes: {
  type: Array,
  default() {
    return [20, 50, 100]  // 支持的分页选项
  }
}
```

## 三、实施步骤

1. **创建VO和Mapper扩展**：
   - 创建CommentVO类
   - 创建CommentMapperExt接口和XML文件
   - 实现多表关联查询

2. **修改后端Controller**：
   - 修改AdminCommentController的list方法
   - 增加智能搜索逻辑
   - 提高分页限制

3. **修改前端页面**：
   - 修改comment.vue的表格列配置
   - 实现合并搜索框
   - 增加评分排序功能
   - 优化分页组件

4. **测试验证**：
   - 测试搜索功能
   - 测试排序功能
   - 测试分页功能

## 四、注意事项

1. **数据库性能**：
   - 多表关联查询可能影响性能，建议在商品表和评论表上建立合适的索引
   - 考虑使用缓存机制缓存商品名称和类别信息

2. **安全性**：
   - 防止SQL注入，使用参数化查询
   - 验证输入参数的有效性

3. **兼容性**：
   - 保持与原有API的兼容性
   - 考虑向后兼容的问题

4. **用户体验**：
   - 提供清晰的搜索提示
   - 优化加载速度
   - 提供友好的错误提示

## 五、扩展建议

1. **高级搜索**：
   - 增加评分范围搜索
   - 增加评论时间范围搜索
   - 增加是否有图片筛选

2. **数据分析**：
   - 增加评论统计图表
   - 增加评分分布统计
   - 增加商品类别评论统计

3. **批量操作**：
   - 增加批量删除功能
   - 增加批量回复功能
   - 增加批量导出功能