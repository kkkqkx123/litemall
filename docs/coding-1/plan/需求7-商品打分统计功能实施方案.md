# 需求7：商品打分统计功能实施方案

## 需求描述
实现商品打分统计功能（前端+后端）：
- 初始列表显示商品ID、商品名称、商品类别、打分平均分（支持按平均分排序）、打分用户数
- 搜索功能：选择商品类别，按打分平均分高低显示该类别下商品

## 现有系统分析

### 数据库结构分析
根据代码库分析，现有相关表结构如下：

**litemall_comment表（评论表）**
```sql
CREATE TABLE `litemall_comment` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `value_id` int(11) NOT NULL DEFAULT '0' COMMENT '如果type=0，则是商品评论；如果是type=1，则是专题评论。',
  `type` tinyint(3) NOT NULL DEFAULT '0' COMMENT '评论类型，如果type=0，则是商品评论；如果是type=1，则是专题评论；',
  `content` varchar(1023) DEFAULT '' COMMENT '评论内容',
  `admin_content` varchar(511) DEFAULT '' COMMENT '管理员回复内容',
  `user_id` int(11) NOT NULL DEFAULT '0' COMMENT '用户表的用户ID',
  `has_picture` tinyint(1) DEFAULT '0' COMMENT '是否含有图片',
  `pic_urls` varchar(1023) DEFAULT NULL COMMENT '图片地址列表，采用JSON数组格式',
  `star` smallint(6) DEFAULT '1' COMMENT '评分， 1-5',
  `add_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  `deleted` tinyint(1) DEFAULT '0' COMMENT '逻辑删除',
  PRIMARY KEY (`id`),
  KEY `id_value` (`value_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1012 DEFAULT CHARSET=utf8mb4 COMMENT='评论表';
```

**litemall_goods表（商品表）**
```sql
CREATE TABLE `litemall_goods` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `goods_sn` varchar(63) NOT NULL DEFAULT '' COMMENT '商品编号',
  `name` varchar(127) NOT NULL DEFAULT '' COMMENT '商品名称',
  `category_id` int(11) DEFAULT '0' COMMENT '商品所属类目ID',
  `brand_id` int(11) DEFAULT '0',
  -- 其他字段省略
  PRIMARY KEY (`id`),
  KEY `goods_sn` (`goods_sn`),
  KEY `cat_id` (`category_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1181004 DEFAULT CHARSET=utf8mb4 COMMENT='商品基本信息表';
```

**litemall_category表（分类表）**
```sql
CREATE TABLE `litemall_category` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(63) NOT NULL DEFAULT '' COMMENT '类目名称',
  `keywords` varchar(1023) NOT NULL DEFAULT '' COMMENT '类目关键字，以JSON数组格式',
  `desc` varchar(255) DEFAULT '' COMMENT '类目广告语介绍',
  `pid` int(11) NOT NULL DEFAULT '0' COMMENT '父类目ID',
  `icon_url` varchar(255) DEFAULT '' COMMENT '类目图标',
  `pic_url` varchar(255) DEFAULT '' COMMENT '类目图片',
  `level` varchar(255) DEFAULT 'L1',
  `sort_order` tinyint(3) DEFAULT '50' COMMENT '排序',
  `add_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  `deleted` tinyint(1) DEFAULT '0' COMMENT '逻辑删除',
  PRIMARY KEY (`id`),
  KEY `parent_id` (`pid`)
) ENGINE=InnoDB AUTO_INCREMENT=1036007 DEFAULT CHARSET=utf8mb4 COMMENT='类目表';
```

### 现有API分析
根据代码库分析，现有相关API接口：

1. **评论相关API** (`/wx/comment/list`)
   - 支持按商品ID获取评论列表
   - 包含评分(star)字段
   - 支持分页查询

2. **商品相关API** (`/admin/goods/list`)
   - 支持商品列表查询
   - 包含商品基本信息和分类信息
   - 支持分页和排序

3. **统计相关API** (`/admin/stat/*`)
   - 现有用户统计、订单统计、商品统计
   - 使用StatVo统一返回格式
   - 支持图表展示

## 技术方案

### 1. 数据库层实现

#### 创建商品评分统计视图
```sql
-- 商品评分统计视图
CREATE OR REPLACE VIEW goods_rating_statistics AS
SELECT 
    g.id AS goods_id,
    g.name AS goods_name,
    g.category_id,
    c.name AS category_name,
    COALESCE(AVG(cmt.star), 0) AS avg_rating,
    COALESCE(COUNT(cmt.id), 0) AS rating_count,
    g.add_time
FROM litemall_goods g
LEFT JOIN litemall_category c ON g.category_id = c.id
LEFT JOIN litemall_comment cmt ON g.id = cmt.value_id AND cmt.type = 0 AND cmt.deleted = 0
WHERE g.deleted = 0
GROUP BY g.id, g.name, g.category_id, c.name, g.add_time;

-- 添加索引优化
CREATE INDEX idx_comment_value_type ON litemall_comment(value_id, type);
CREATE INDEX idx_goods_category ON litemall_goods(category_id);
```

#### 扩展StatMapper.xml
在现有统计模块基础上，添加商品评分统计SQL：
```xml
<!-- 商品评分统计 -->
<select id="statGoodsRating" resultType="map">
    SELECT 
        g.id AS goods_id,
        g.name AS goods_name,
        c.name AS category_name,
        COALESCE(AVG(cmt.star), 0) AS avg_rating,
        COALESCE(COUNT(cmt.id), 0) AS rating_count
    FROM litemall_goods g
    LEFT JOIN litemall_category c ON g.category_id = c.id
    LEFT JOIN litemall_comment cmt ON g.id = cmt.value_id AND cmt.type = 0 AND cmt.deleted = 0
    WHERE g.deleted = 0
    <if test="categoryId != null">
        AND g.category_id = #{categoryId}
    </if>
    GROUP BY g.id, g.name, c.name
    <choose>
        <when test="sort == 'avg_rating' and order == 'asc'">
            ORDER BY avg_rating ASC, rating_count DESC
        </when>
        <when test="sort == 'avg_rating' and order == 'desc'">
            ORDER BY avg_rating DESC, rating_count DESC
        </when>
        <otherwise>
            ORDER BY g.add_time DESC
        </otherwise>
    </choose>
</select>

<!-- 商品分类列表（用于筛选） -->
<select id="statGoodsCategories" resultType="map">
    SELECT DISTINCT
        c.id,
        c.name
    FROM litemall_category c
    INNER JOIN litemall_goods g ON c.id = g.category_id
    WHERE c.deleted = 0 AND g.deleted = 0
    ORDER BY c.sort_order, c.name
</select>
```

### 2. 后端实现

#### 扩展StatService
```java
@Service
public class StatService {
    
    @Autowired
    private StatMapper statMapper;
    
    /**
     * 商品评分统计
     */
    public Object statGoodsRating(Integer categoryId, String sort, String order, 
                                  Integer page, Integer limit) {
        
        // 参数校验
        if (page == null || page < 1) {
            page = 1;
        }
        if (limit == null || limit < 1 || limit > 100) {
            limit = 20;
        }
        
        // 排序字段校验
        if (!"avg_rating".equals(sort)) {
            sort = null;
        }
        if (!"asc".equals(order) && !"desc".equals(order)) {
            order = "desc";
        }
        
        // 计算分页
        int offset = (page - 1) * limit;
        
        // 查询数据
        Map<String, Object> params = new HashMap<>();
        params.put("categoryId", categoryId);
        params.put("sort", sort);
        params.put("order", order);
        params.put("offset", offset);
        params.put("limit", limit);
        
        List<Map<String, Object>> list = statMapper.statGoodsRating(params);
        
        // 查询总数（用于分页）
        int total = statMapper.countGoodsRating(params);
        
        // 构建返回结果
        Map<String, Object> result = new HashMap<>();
        result.put("list", list);
        result.put("total", total);
        result.put("page", page);
        result.put("limit", limit);
        result.put("pages", (int) Math.ceil((double) total / limit));
        
        return ResponseUtil.ok(result);
    }
    
    /**
     * 获取商品分类列表（用于筛选）
     */
    public Object statGoodsCategories() {
        List<Map<String, Object>> categories = statMapper.statGoodsCategories();
        return ResponseUtil.ok(categories);
    }
}
```

#### 扩展AdminStatController
```java
@RestController
@RequestMapping("/admin/stat")
@Validated
public class AdminStatController {
    
    @Autowired
    private StatService statService;
    
    /**
     * 商品评分统计
     */
    @GetMapping("/goods/rating")
    public Object statGoodsRating(
            @RequestParam(required = false) Integer categoryId,
            @RequestParam(required = false) String sort,
            @RequestParam(required = false, defaultValue = "desc") String order,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer limit) {
        
        return statService.statGoodsRating(categoryId, sort, order, page, limit);
    }
    
    /**
     * 商品分类列表（用于筛选）
     */
    @GetMapping("/goods/categories")
    public Object statGoodsCategories() {
        return statService.statGoodsCategories();
    }
}
```

### 3. 前端实现

#### 创建商品评分统计页面
创建文件：`litemall-admin/src/views/stat/goodsRating.vue`

```vue
<template>
  <div class="app-container">
    <div class="filter-container">
      <el-select v-model="listQuery.categoryId" placeholder="选择商品类别" clearable style="width: 200px" class="filter-item">
        <el-option v-for="item in categoryOptions" :key="item.id" :label="item.name" :value="item.id" />
      </el-select>
      <el-button v-waves class="filter-item" type="primary" icon="el-icon-search" @click="handleFilter">
        搜索
      </el-button>
    </div>

    <el-table
      :key="tableKey"
      v-loading="listLoading"
      :data="list"
      border
      fit
      highlight-current-row
      style="width: 100%;">
      
      <el-table-column label="商品ID" prop="goods_id" align="center" width="80">
        <template slot-scope="scope">
          <span>{{ scope.row.goods_id }}</span>
        </template>
      </el-table-column>
      
      <el-table-column label="商品名称" prop="goods_name" min-width="150px">
        <template slot-scope="scope">
          <span class="link-type">{{ scope.row.goods_name }}</span>
        </template>
      </el-table-column>
      
      <el-table-column label="商品类别" prop="category_name" width="120px" align="center">
        <template slot-scope="scope">
          <span>{{ scope.row.category_name || '-' }}</span>
        </template>
      </el-table-column>
      
      <el-table-column label="打分平均分" prop="avg_rating" width="120px" align="center" sortable="custom">
        <template slot-scope="scope">
          <el-rate
            v-model="scope.row.avg_rating"
            disabled
            show-score
            text-color="#ff9900"
            score-template="{value}">
          </el-rate>
        </template>
      </el-table-column>
      
      <el-table-column label="打分用户数" prop="rating_count" width="100px" align="center">
        <template slot-scope="scope">
          <span>{{ scope.row.rating_count }}</span>
        </template>
      </el-table-column>
      
    </el-table>

    <pagination v-show="total>0" :total="total" :page.sync="listQuery.page" :limit.sync="listQuery.limit" @pagination="getList" />

  </div>
</template>

<script>
import { statGoodsRating, statGoodsCategories } from '@/api/stat'
import waves from '@/directive/waves'
import Pagination from '@/components/Pagination'

export default {
  name: 'GoodsRatingStat',
  components: { Pagination },
  directives: { waves },
  data() {
    return {
      tableKey: 0,
      list: null,
      total: 0,
      listLoading: true,
      listQuery: {
        page: 1,
        limit: 20,
        categoryId: undefined,
        sort: undefined,
        order: undefined
      },
      categoryOptions: []
    }
  },
  created() {
    this.getList()
    this.getCategories()
  },
  methods: {
    getList() {
      this.listLoading = true
      statGoodsRating(this.listQuery).then(response => {
        this.list = response.data.data.list
        this.total = response.data.data.total
        this.listLoading = false
      }).catch(() => {
        this.listLoading = false
      })
    },
    getCategories() {
      statGoodsCategories().then(response => {
        this.categoryOptions = response.data.data
      })
    },
    handleFilter() {
      this.listQuery.page = 1
      this.getList()
    },
    sortChange(data) {
      const { prop, order } = data
      if (prop === 'avg_rating') {
        this.listQuery.sort = 'avg_rating'
        this.listQuery.order = order === 'ascending' ? 'asc' : 'desc'
        this.handleFilter()
      }
    }
  }
}
</script>
```

#### 扩展API接口
修改文件：`litemall-admin/src/api/stat.js`

```javascript
// 商品评分统计
export function statGoodsRating(query) {
  return request({
    url: '/stat/goods/rating',
    method: 'get',
    params: query
  })
}

// 商品分类列表（用于筛选）
export function statGoodsCategories() {
  return request({
    url: '/stat/goods/categories',
    method: 'get'
  })
}
```

#### 添加路由配置
修改文件：`litemall-admin/src/router/index.js`

```javascript
{
  path: '/stat/goodsRating',
  component: Layout,
  redirect: '/stat/goodsRating',
  name: 'goodsRatingStat',
  meta: {
    title: '商品评分统计',
    icon: 'chart'
  },
  children: [
    {
      path: 'list',
      name: 'goodsRatingList',
      component: () => import('@/views/stat/goodsRating'),
      meta: { title: '商品评分统计', icon: 'star' }
    }
  ]
}
```

### 4. 性能优化

#### 数据库优化
1. **索引优化**
   - 在litemall_comment表的(value_id, type)字段上创建复合索引
   - 在litemall_goods表的category_id字段上创建索引
   - 在litemall_category表的deleted字段上创建索引

2. **查询优化**
   - 使用LEFT JOIN确保没有评论的商品也能显示
   - 使用COALESCE函数处理NULL值
   - 合理使用GROUP BY和ORDER BY

#### 缓存策略
1. **分类数据缓存**：商品分类数据变化频率低，可缓存较长时间
2. **统计结果缓存**：评分统计数据可设置5-10分钟的缓存
3. **分页缓存**：相同查询条件的分页数据可缓存

#### 前端优化
1. **分页加载**：避免一次性加载大量数据
2. **防抖搜索**：搜索框添加防抖处理
3. **懒加载**：评分星星组件使用懒加载

## 测试方案
仅功能测试即可

### 功能测试
1. **列表显示测试**
   - 验证商品ID、名称、类别正确显示
   - 验证评分平均分计算准确
   - 验证打分用户数统计正确

2. **排序功能测试**
   - 测试按评分升序排序
   - 测试按评分降序排序
   - 验证相同评分的商品排序规则

3. **搜索功能测试**
   - 测试按类别筛选功能
   - 测试类别下拉框数据正确性
   - 验证搜索后分页功能正常
