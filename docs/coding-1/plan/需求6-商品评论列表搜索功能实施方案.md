# 需求6：商品管理-商品评论页面列表及搜索功能调整实施方案

## 需求描述
实现列表及搜索功能调整：
- 增加商品名称、商品类别列，删除评论图片列
- 时间列仅显示年月日
- 合并搜索输入框，支持根据用户ID或商品名称（模糊搜索）查询
- 输入用户ID搜索，显示该用户给所有商品的打分记录
- 输入商品名称搜索，显示所有给该商品打分的用户记录
- 打分列增加排序功能，点击可切换排序方式

## 技术方案

### 数据库查询优化

1. **修改评论列表查询SQL**
   ```xml
   <select id="selectCommentWithDetails" resultMap="CommentDetailResult">
       SELECT 
           c.id,
           c.user_id,
           u.nickname as user_name,
           c.value as rating,
           c.content,
           DATE(c.add_time) as add_time,
           g.id as goods_id,
           g.name as goods_name,
           gc.name as category_name
       FROM litemall_comment c
       INNER JOIN litemall_user u ON c.user_id = u.id
       INNER JOIN litemall_goods g ON c.value_id = g.id
       LEFT JOIN litemall_category gc ON g.category_id = gc.id
       WHERE c.type = 0
       <if test="userId != null">
           AND c.user_id = #{userId}
       </if>
       <if test="goodsName != null and goodsName != ''">
           AND g.name LIKE CONCAT('%', #{goodsName}, '%')
       </if>
       <if test="sort != null and sort == 'rating'">
           ORDER BY c.value ${order}
       </if>
       <if test="sort == null or sort != 'rating'">
           ORDER BY c.add_time DESC
       </if>
   </select>
   ```

### 后端实现

1. **Controller层接口修改**
   ```java
   @GetMapping("/list")
   public Object list(@RequestParam(defaultValue = "1") Integer page,
                      @RequestParam(defaultValue = "10") Integer limit,
                      @RequestParam(required = false) String searchValue,
                      @RequestParam(required = false) String sort,
                      @RequestParam(required = false) String order) {
       
       // 解析搜索值（可能是用户ID或商品名称）
       Integer userId = null;
       String goodsName = null;
       
       if (!StringUtils.isEmpty(searchValue)) {
           // 尝试解析为用户ID
           try {
               userId = Integer.parseInt(searchValue);
           } catch (NumberFormatException e) {
               // 不是数字，作为商品名称处理
               goodsName = searchValue;
           }
       }
       
       // 构建查询条件
       Map<String, Object> params = new HashMap<>();
       params.put("userId", userId);
       params.put("goodsName", goodsName);
       params.put("sort", sort);
       params.put("order", order);
       
       PageHelper.startPage(page, limit);
       List<CommentDetailVo> commentList = commentService.getCommentListWithDetails(params);
       
       return ResponseUtil.okList(commentList);
   }
   ```

2. **VO对象设计**
   ```java
   public class CommentDetailVo {
       private Integer id;
       private Integer userId;
       private String userName;
       private Byte rating; // 打分
       private String content;
       private LocalDate addTime; // 只显示年月日
       private Integer goodsId;
       private String goodsName;
       private String categoryName;
       // getter/setter省略
   }
   ```

### 前端实现

1. **表格列配置**
   ```javascript
   // 修改表格列配置
   columns: [
     {
       title: '用户ID',
       key: 'userId',
       width: 80
     },
     {
       title: '用户名称',
       key: 'userName',
       width: 120
     },
     {
       title: '商品ID',
       key: 'goodsId',
       width: 80
     },
     {
       title: '商品名称',
       key: 'goodsName',
       minWidth: 150,
       ellipsis: true
     },
     {
       title: '商品类别',
       key: 'categoryName',
       width: 120
     },
     {
       title: '打分',
       key: 'rating',
       width: 100,
       sortable: 'custom', // 支持排序
       render: (h, params) => {
         return h('div', [
           h('Rate', {
             props: {
               value: params.row.rating,
               disabled: true,
               size: 'small'
             }
           }),
           h('span', {
             style: {
               marginLeft: '8px'
             }
           }, params.row.rating + '分')
         ])
       }
     },
     {
       title: '评论内容',
       key: 'content',
       minWidth: 200,
       ellipsis: true
     },
     {
       title: '评论时间',
       key: 'addTime',
       width: 120,
       render: (h, params) => {
         return h('span', params.row.addTime) // 只显示年月日
       }
     }
   ]
   ```

2. **合并搜索输入框**
   ```javascript
   // 搜索组件
   <div style="margin-bottom: 16px">
     <el-input
       v-model="searchValue"
       placeholder="请输入用户ID或商品名称"
       style="width: 300px; margin-right: 8px"
       clearable
       @keyup.enter.native="handleSearch"
       @clear="handleSearch">
       <el-button slot="append" icon="el-icon-search" @click="handleSearch"></el-button>
     </el-input>
     <el-button @click="handleReset">重置</el-button>
   </div>
   ```

3. **排序处理**
   ```javascript
   methods: {
     handleSortChange({ prop, order }) {
       this.listQuery.sort = prop
       this.listQuery.order = order === 'ascending' ? 'ASC' : 'DESC'
       this.getList()
     },
     
     handleSearch() {
       this.listQuery.page = 1
       this.listQuery.searchValue = this.searchValue
       this.getList()
     }
   }
   ```

## 智能搜索逻辑

1. **搜索值类型判断**
   ```javascript
   // 前端提示
   watch: {
     searchValue(val) {
       if (!val) {
         this.searchTip = ''
         return
       }
       
       if (/^\d+$/.test(val)) {
         this.searchTip = '正在搜索用户ID为 ' + val + ' 的评论'
       } else {
         this.searchTip = '正在搜索商品名称包含 "' + val + '" 的评论'
       }
     }
   }
   ```

## 实施步骤
1. 修改数据库查询，关联商品和类别表
2. 后端开发新的评论列表API
3. 前端修改表格列配置
4. 实现合并搜索框和智能搜索
5. 添加打分列排序功能
6. 测试各种搜索场景

## 预计工作量
- 后端开发：4-6小时
- 前端开发：6-8小时
- 测试时间：3小时

## 注意事项
- 考虑搜索性能，添加适当的索引
- 处理用户ID和商品名称的冲突情况
- 添加搜索历史记录（可选）
- 考虑评论内容的敏感词过滤
- 实现分页加载优化