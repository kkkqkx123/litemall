# 需求4：订单统计功能拓展实施方案

## 需求描述
订单统计功能拓展：按日、月、季、年统计，按商品类别统计（默认显示所有类别）。

## 技术方案

### 前端实现

1. **时间维度选择器**
   ```javascript
   // 添加时间维度选择
   <el-select v-model="timeDimension" placeholder="选择时间维度">
     <el-option label="按日" value="day"></el-option>
     <el-option label="按月" value="month"></el-option>
     <el-option label="按季" value="quarter"></el-option>
     <el-option label="按年" value="year"></el-option>
   </el-select>
   ```

2. **商品类别选择器**
   ```javascript
   // 添加商品类别选择
   <el-select v-model="categoryId" placeholder="选择商品类别" clearable>
     <el-option 
       v-for="category in categories" 
       :key="category.id" 
       :label="category.name" 
       :value="category.id">
     </el-option>
   </el-select>
   ```

3. **统计图表组件**
   ```javascript
   // 使用ECharts或类似图表库
   <div ref="chart" style="width: 100%; height: 400px;"></div>
   ```

### 后端实现

1. **统计API接口**
   ```java
   @GetMapping("/order/statistics")
   public Object getOrderStatistics(
       @RequestParam String dimension, // day, month, quarter, year
       @RequestParam(required = false) Integer categoryId,
       @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
       @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate) {
       
       Map<String, Object> result = new HashMap<>();
       
       switch (dimension) {
           case "day":
               result = orderService.getDailyStatistics(startDate, endDate, categoryId);
               break;
           case "month":
               result = orderService.getMonthlyStatistics(startDate, endDate, categoryId);
               break;
           case "quarter":
               result = orderService.getQuarterlyStatistics(startDate, endDate, categoryId);
               break;
           case "year":
               result = orderService.getYearlyStatistics(startDate, endDate, categoryId);
               break;
       }
       
       return ResponseUtil.ok(result);
   }
   ```

2. **Service层统计逻辑**
   ```java
   public Map<String, Object> getDailyStatistics(LocalDate startDate, LocalDate endDate, Integer categoryId) {
       Map<String, Object> result = new HashMap<>();
       
       // 构建查询条件
       LitemallOrderExample example = new LitemallOrderExample();
       LitemallOrderExample.Criteria criteria = example.createCriteria();
       
       criteria.andAddTimeBetween(
           startDate.atStartOfDay(), 
           endDate.atTime(LocalTime.MAX)
       );
       
       if (categoryId != null) {
           // 关联商品类别查询
           List<Integer> orderIds = orderGoodsService.getOrderIdsByCategory(categoryId);
           criteria.andIdIn(orderIds);
       }
       
       // 按日期分组统计
       List<Map<String, Object>> dailyStats = orderMapper.getDailyStatistics(example);
       
       result.put("dates", dailyStats.stream().map(m -> m.get("date")).collect(Collectors.toList()));
       result.put("orderCounts", dailyStats.stream().map(m -> m.get("orderCount")).collect(Collectors.toList()));
       result.put("orderAmounts", dailyStats.stream().map(m -> m.get("orderAmount")).collect(Collectors.toList()));
       
       return result;
   }
   ```

3. **Mapper SQL查询**
   ```xml
   <select id="getDailyStatistics" resultType="map">
       SELECT 
           DATE(add_time) as date,
           COUNT(*) as orderCount,
           SUM(actual_price) as orderAmount
       FROM litemall_order
       <where>
           <if test="oredCriteria != null">
               <foreach collection="oredCriteria" item="criteria">
                   <if test="criteria.valid">
                       ${criteria.condition}
                   </if>
               </foreach>
           </if>
       </where>
       GROUP BY DATE(add_time)
       ORDER BY date ASC
   </select>
   ```

## 数据结构设计
```javascript
// 返回数据结构
{
  "errno": 0,
  "data": {
    "dates": ["2024-01-01", "2024-01-02", ...],
    "orderCounts": [10, 15, ...],
    "orderAmounts": [1000.00, 1500.00, ...],
    "totalCount": 100,
    "totalAmount": 50000.00,
    "avgAmount": 500.00
  }
}
```

## 实施步骤
1. 设计统计查询SQL，支持时间维度和商品类别筛选
2. 开发后端统计API接口
3. 前端添加时间维度和类别选择器
4. 集成图表库展示统计数据
5. 实现数据导出功能（可选）
6. 测试各种统计维度

## 预计工作量
- 后端开发：6-8小时
- 前端开发：8-10小时
- 测试时间：3-4小时

## 注意事项
- 考虑大数据量查询性能优化
- 添加查询时间范围限制（如最多查询一年数据）
- 实现数据缓存机制
- 考虑图表的响应式适配
- 添加加载状态提示