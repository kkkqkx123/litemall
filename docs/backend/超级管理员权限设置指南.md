# 超级管理员权限设置指南

## 概述

Litemall系统采用基于角色的权限控制（RBAC）机制，超级管理员拥有系统的最高权限。本指南详细说明如何正确设置和管理超级管理员的权限，确保系统功能正常运行。

## 权限系统架构

### 核心概念

- **角色（Role）**：系统中定义的用户角色类型
- **权限（Permission）**：具体的操作权限标识
- **用户（User）**：系统中的登录用户
- **权限分配**：将权限分配给特定角色

### 数据库表结构

#### litemall_role 表（角色表）
- `id`：角色唯一标识
- `name`：角色名称
- `description`：角色描述

#### litemall_permission 表（权限表）
- `id`：权限记录唯一标识
- `role_id`：角色ID，关联到litemall_role表
- `permission`：权限标识字符串
- `add_time`：创建时间
- `update_time`：更新时间
- `deleted`：删除标记（0=未删除，1=已删除）

#### litemall_user_role 表（用户角色关联表）
- `user_id`：用户ID，关联到litemall_user表
- `role_id`：角色ID，关联到litemall_role表

### 预定义角色

系统中预定义了以下角色：

| 角色ID | 角色名称 | 描述 |
|--------|----------|------|
| 1 | 超级管理员 | 拥有系统最高权限 |
| 2 | 商场管理员 | 管理商品、订单等业务功能 |
| 3 | 推广管理员 | 管理广告、团购等推广活动 |

## 超级管理员权限设置

### 默认权限

超级管理员（role_id=1）默认拥有通配符权限：

```sql
-- 通配符权限，表示拥有所有权限
permission: "*"
```

### 补充权限

除了通配符权限外，系统还为超级管理员定义了以下具体权限：

#### LLM QA功能权限（新增）
- `admin:llm:qa:ask` - 问答功能
- `admin:llm:qa:history` - 查看历史记录
- `admin:llm:qa:clear` - 清除记录
- `admin:llm:qa:list` - 列表查看
- `admin:llm:qa:read` - 读取详情
- `admin:llm:qa:delete` - 删除记录

#### 统计管理权限
- `admin:stat:order` - 订单统计
- `admin:stat:user` - 用户统计
- `admin:stat:goods` - 商品统计

## 权限管理操作

### 查看当前权限设置

#### 查看超级管理员的所有权限
```sql
SELECT * FROM litemall_permission WHERE role_id = 1 ORDER BY id;
```

#### 查看特定模块的权限
```sql
-- 查看LLM QA相关权限
SELECT * FROM litemall_permission WHERE permission LIKE '%llm:qa%';

-- 查看统计相关权限
SELECT * FROM litemall_permission WHERE permission LIKE '%stat%';
```

### 添加权限

#### 为超级管理员添加单个权限
```sql
INSERT INTO litemall_permission (role_id, permission, add_time, update_time, deleted)
VALUES (1, 'admin:new:module:action', NOW(), NOW(), 0);
```

#### 为超级管理员添加多个权限
```sql
INSERT INTO litemall_permission (role_id, permission, add_time, update_time, deleted)
VALUES 
(1, 'admin:module1:action1', NOW(), NOW(), 0),
(1, 'admin:module1:action2', NOW(), NOW(), 0),
(1, 'admin:module2:action1', NOW(), NOW(), 0);
```

### 删除权限
```sql
-- 软删除（设置deleted标记）
UPDATE litemall_permission 
SET deleted = 1, update_time = NOW() 
WHERE role_id = 1 AND permission = 'admin:module:action';

-- 硬删除（实际删除记录）
DELETE FROM litemall_permission 
WHERE role_id = 1 AND permission = 'admin:module:action';
```

### 更新权限描述
```sql
UPDATE litemall_permission 
SET update_time = NOW() 
WHERE role_id = 1 AND permission = 'admin:module:action';
```

## 权限验证

### 数据库级别验证

#### 检查权限表中的权限数量
```sql
SELECT COUNT(*) as permission_count 
FROM litemall_permission 
WHERE role_id = 1 AND deleted = 0;
```

#### 检查特定权限是否存在
```sql
SELECT COUNT(*) as permission_exists 
FROM litemall_permission 
WHERE role_id = 1 
  AND permission = 'admin:stat:order' 
  AND deleted = 0;
```

### API级别验证

#### 使用curl命令验证统计接口
```bash
# 登录获取token
curl -X POST "http://localhost:8080/admin/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin123","password":"admin123"}'

# 测试订单统计接口
curl -X GET "http://localhost:8080/admin/stat/order?timeDimension=week&categoryId=0" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

#### 期望的响应结果
```json
{
  "errno": 0,
  "data": {
    "columns": ["day", "orders", "customers", "amount", "pcr"],
    "rows": [...]
  },
  "errmsg": "成功"
}
```

### 前端界面验证

1. 登录管理后台（http://localhost:9527/）
2. 访问订单统计页面（#/stat/order）
3. 确认图表和数据正常显示

## 权限初始化脚本

### SQL脚本位置

权限初始化脚本位于：
```
litemall-db/sql/litemall_data.sql
```

### 脚本内容示例

权限表数据的INSERT语句：
```sql
-- Dumping data for table `litemall_permission`
LOCK TABLES `litemall_permission` WRITE;
/*!40000 ALTER TABLE `litemall_permission` DISABLE KEYS */;
INSERT INTO `litemall_permission` VALUES 
(1,1,'*','2019-01-01 00:00:00','2019-01-01 00:00:00',0),
-- LLM QA权限
(32,1,'admin:llm:qa:ask','2024-01-01 00:00:00','2024-01-01 00:00:00',0),
(33,1,'admin:llm:qa:history','2024-01-01 00:00:00','2024-01-01 00:00:00',0),
(34,1,'admin:llm:qa:clear','2024-01-01 00:00:00','2024-01-01 00:00:00',0),
(35,1,'admin:llm:qa:list','2024-01-01 00:00:00','2024-01-01 00:00:00',0),
(36,1,'admin:llm:qa:read','2024-01-01 00:00:00','2024-01-01 00:00:00',0),
(37,1,'admin:llm:qa:delete','2024-01-01 00:00:00','2024-01-01 00:00:00',0),
-- 统计管理权限
(38,1,'admin:stat:order','2024-01-01 00:00:00','2024-01-01 00:00:00',0),
(39,1,'admin:stat:user','2024-01-01 00:00:00','2024-01-01 00:00:00',0),
(40,1,'admin:stat:goods','2024-01-01 00:00:00','2024-01-01 00:00:00',0);
/*!40000 ALTER TABLE `litemall_permission` ENABLE KEYS */;
UNLOCK TABLES;
```

## 常见问题和解决方案

### 1. 权限不足错误

**问题描述**：访问某些功能时返回403 Forbidden错误

**原因分析**：
- 用户角色缺少相应权限
- 权限数据未正确同步到数据库
- 前端路由权限验证问题

**解决方案**：
```sql
-- 检查用户角色
SELECT u.username, r.name as role_name 
FROM litemall_user u
JOIN litemall_user_role ur ON u.id = ur.user_id
JOIN litemall_role r ON ur.role_id = r.id
WHERE u.username = 'admin123';

-- 检查权限配置
SELECT * FROM litemall_permission 
WHERE role_id = 1 AND permission LIKE '%stat%';
```

### 2. 数据初始化问题

**问题描述**：新部署的系统缺少必要的权限数据

**解决方案**：
1. 确认litemall_data.sql脚本完整性
2. 执行数据库初始化脚本
3. 验证权限数据是否正确插入

### 3. 权限缓存问题

**问题描述**：权限修改后前端仍显示权限不足

**解决方案**：
1. 清除浏览器缓存
2. 重新登录用户
3. 重启后端服务

### 4. 订单统计页面为空

**问题描述**：订单统计页面无法显示数据

**解决方案**：
```sql
-- 检查是否有订单数据
SELECT COUNT(*) as order_count 
FROM litemall_order 
WHERE order_status IN (201,301,401,402);

-- 检查统计权限
SELECT * FROM litemall_permission 
WHERE role_id = 1 AND permission = 'admin:stat:order';
```

## 最佳实践

### 1. 权限设计原则

- **最小权限原则**：只分配必要的权限
- **职责分离**：不同功能分配给不同角色
- **定期审查**：定期检查和更新权限设置

### 2. 安全管理建议

- **强密码策略**：确保管理员账户使用强密码
- **定期更换密码**：建议每3个月更换一次密码
- **访问日志记录**：记录所有管理操作日志
- **权限审计**：定期审计权限分配的合理性

### 3. 部署建议

- **权限脚本版本控制**：权限初始化脚本应纳入版本控制
- **环境一致性**：确保开发、测试、生产环境权限一致
- **备份策略**：定期备份权限配置数据

## 更新日志

| 版本 | 日期 | 更新内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2024-12-19 | 初始版本，包含基本权限管理说明 | AI助手 |
| 1.1 | 2024-12-19 | 添加LLM QA权限和统计权限说明 | AI助手 |

## 联系支持

如遇到权限相关问题，请：

1. 查阅本文档的常见问题章节
2. 检查系统日志：`litemall-all/logs/log.log`
3. 联系技术支持团队

---

*本文档适用于litemall开源商城系统v1.0+*