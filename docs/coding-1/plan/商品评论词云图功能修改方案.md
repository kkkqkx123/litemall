# 商品评论词云图功能修改方案

## 现状分析

### 当前实现情况

#### 1. 后端实现
- **AdminStatController**: 提供 `/stat/goods/wordcloud/{goodsId}` 接口，仅支持单个商品的词云生成
- **WordCloudService**: 实现了基础的中文分词和词频统计，但算法较简单，存在生成句子而非词语的问题
- **StatMapper**: 提供 `getGoodsComments` 方法，仅支持按商品ID查询评论

#### 2. 前端实现
- **comment.vue**: 
  - 显示全局词云（固定使用热门商品ID `[1181000, 1006002]`）
  - 商品列表中每个商品都有"查看词云"按钮
  - 词云对话框显示单个商品的词云

#### 3. 主要问题
1. **单个商品词云需要删除**：每个商品都有词云按钮，用户体验不佳
2. **全局词云需要支持分类过滤**：当前使用固定商品ID，无法根据分类筛选
3. **词云算法问题**：生成的是句子而非词语，分词算法需要改进
4. **数据库查询限制**：当前只支持按商品ID查询，需要支持分类级别的评论查询

## 修改方案

### 1. 数据库层修改（StatMapper.xml）

#### 新增方法：按分类获取评论内容
```xml
<!-- 获取分类下所有商品的评论内容（用于全局词云） -->
<select id="getCommentsByCategory" resultType="map">
    SELECT c.content
    FROM litemall_comment c
    INNER JOIN litemall_goods g ON c.value_id = g.id
    WHERE c.type = 0 AND c.deleted = 0
    <if test="categoryId != null">
        AND g.category_id = #{categoryId}
    </if>
    ORDER BY c.add_time DESC
    LIMIT 1000  <!-- 限制查询数量，避免性能问题 -->
</select>

<!-- 获取全站所有评论内容（用于全局词云） -->
<select id="getAllComments" resultType="map">
    SELECT content
    FROM litemall_comment
    WHERE type = 0 AND deleted = 0
    ORDER BY add_time DESC
    LIMIT 1000  <!-- 限制查询数量，避免性能问题 -->
</select>
```

#### 修改现有方法：支持批量商品评论获取
```xml
<!-- 修改getGoodsComments支持多个商品ID -->
<select id="getGoodsComments" resultType="map">
    SELECT content
    FROM litemall_comment
    WHERE type = 0 AND deleted = 0
    <choose>
        <when test="goodsIds != null and goodsIds.size() > 0">
            AND value_id IN
            <foreach collection="goodsIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </when>
        <otherwise>
            AND value_id = #{goodsId}
        </otherwise>
    </choose>
    ORDER BY add_time DESC
</select>
```

### 2. 后端服务修改

#### StatMapper.java 新增方法
```java
/**
 * 获取分类下所有商品的评论内容（用于全局词云）
 * @param categoryId 商品分类ID，可为null
 * @return 评论内容列表
 */
List<Map> getCommentsByCategory(@Param("categoryId") Integer categoryId);

/**
 * 获取全站所有评论内容（用于全局词云）
 * @return 评论内容列表
 */
List<Map> getAllComments();
```

#### StatService.java 新增方法
```java
/**
 * 获取分类下所有商品的评论内容（用于全局词云）
 * @param categoryId 商品分类ID，可为null
 * @return 评论内容列表
 */
public List<Map> getCommentsByCategory(Integer categoryId) {
    if (categoryId != null && categoryId > 0) {
        return statMapper.getCommentsByCategory(categoryId);
    } else {
        return statMapper.getAllComments();
    }
}
```

#### WordCloudService.java 分词算法优化
```java
// 改进分词算法，使用更智能的中文分词
private List<String> segmentText(String text) {
    if (text == null || text.trim().isEmpty()) {
        return new ArrayList<>();
    }
    
    // 1. 文本预处理
    text = text.replaceAll("[^\\u4e00-\\u9fa5a-zA-Z0-9]", " "); // 只保留中文、英文、数字
    text = text.toLowerCase();
    
    List<String> words = new ArrayList<>();
    
    // 2. 中文分词（改进版）
    // 使用常见词语库进行匹配
    String[] commonWords = {
        "不错", "很好", "满意", "质量", "服务", "物流", "包装", "价格", "便宜", "实惠",
        "好用", "喜欢", "推荐", "购买", "值得", "下次", "还会", "继续", "支持", "好评",
        "差评", "不好", "失望", "退货", "退款", "问题", "质量差", "假货", "骗子", "垃圾",
        "快递", "发货", "速度", "客服", "态度", "描述", "相符", "图片", "实物", "色差",
        "尺寸", "大小", "合适", "刚好", "太大", "太小", "舒适", "漂亮", "美观", "精致"
    };
    
    // 先匹配常见词语
    for (String word : commonWords) {
        if (text.contains(word)) {
            words.add(word);
            text = text.replace(word, " ");
        }
    }
    
    // 然后按字符分割处理剩余文本
    String[] chars = text.split("\\s+");
    for (String charSeq : chars) {
        if (charSeq.length() >= 2) { // 至少2个字符
            // 提取2-4个字符的词组
            for (int i = 0; i <= charSeq.length() - 2; i++) {
                int maxLen = Math.min(4, charSeq.length() - i);
                for (int len = 2; len <= maxLen; len++) {
                    String word = charSeq.substring(i, i + len);
                    if (!isStopWord(word) && word.length() >= 2) {
                        words.add(word);
                    }
                }
            }
        }
    }
    
    return words;
}
```

### 3. AdminStatController修改

#### 新增全局词云接口
```java
/**
 * 全局商品评论词云接口
 * @param categoryId 商品分类ID，可为null（表示全站）
 * @param maxWords 最大词数
 * @return 词云数据
 */
@RequiresPermissions("admin:stat:goods")
@RequiresPermissionsDesc(menu = {"统计管理", "商品评论词云"}, button = "生成全局词云")
@GetMapping("/goods/wordcloud/global")
public Object generateGlobalWordCloud(@RequestParam(value = "categoryId", required = false) Integer categoryId,
                                    @RequestParam(value = "maxWords", defaultValue = "50") Integer maxWords) {
    
    // 参数校验
    if (maxWords == null || maxWords < 1) {
        maxWords = 50;
    }
    if (maxWords > 200) {
        maxWords = 200;
    }
    
    // 获取评论内容
    List<Map> comments = statService.getCommentsByCategory(categoryId);
    if (comments == null || comments.isEmpty()) {
        return ResponseUtil.ok(new ArrayList<>());
    }
    
    // 提取评论文本
    List<String> commentTexts = comments.stream()
        .map(comment -> (String) comment.get("content"))
        .filter(text -> text != null && !text.trim().isEmpty())
        .collect(java.util.stream.Collectors.toList());
    
    if (commentTexts.isEmpty()) {
        return ResponseUtil.ok(new ArrayList<>());
    }
    
    // 生成词云
    List<WordCloudService.WordCloudData> wordCloudData = wordCloudService.generateWordCloud(commentTexts, maxWords);
    
    // 转换为前端期望的格式
    List<Map<String, Object>> result = new ArrayList<>();
    for (WordCloudService.WordCloudData data : wordCloudData) {
        Map<String, Object> item = new HashMap<>();
        item.put("name", data.getText());
        item.put("value", data.getFrequency());
        result.add(item);
    }
    
    return ResponseUtil.ok(result);
}
```

### 4. 前端修改（comment.vue）

#### 移除单个商品词云功能
```javascript
// 移除以下方法
handleViewWordCloud(row) {
  // 移除该方法
},
handleRefreshWordCloud() {
  // 移除该方法  
},
generateWordCloud() {
  // 移除该方法
},

// 移除data中的相关属性
data() {
  return {
    // ... 其他属性
    wordCloudDialogVisible: false,  // 移除
    wordCloudData: [],  // 移除
    currentGoodsId: null,  // 移除
  }
}
```

#### 修改全局词云获取方法
```javascript
// 修改getGlobalWordCloud方法
getGlobalWordCloud() {
  const params = {}
  if (this.listQuery.categoryId) {
    params.categoryId = this.listQuery.categoryId
  }
  
  // 调用新的全局词云接口
  getGlobalWordCloud(params).then(response => {
    if (response.data.data && response.data.data.length > 0) {
      this.globalWordCloudData = response.data.data.map(item => ({
        word: item.name,
        frequency: item.value
      }))
    } else {
      this.globalWordCloudData = []
    }
  }).catch(() => {
    this.globalWordCloudData = []
  })
},

// 修改分类筛选处理
handleFilter() {
  this.listQuery.page = 1
  this.fetchData()
  this.getGlobalWordCloud() // 重新获取词云数据
}
```

#### 修改模板
```html
<!-- 移除商品列表中的查看词云按钮 -->
<el-table-column label="操作" align="center" width="150" class-name="small-padding fixed-width">
  <template slot-scope="scope">
    <!-- 移除查看词云按钮 -->
  </template>
</el-table-column>

<!-- 移除词云对话框 -->
<!-- <el-dialog title="商品评论词云" :visible.sync="wordCloudDialogVisible"> -->
<!-- </el-dialog> -->
```

#### 新增API方法（stat.js）
```javascript
export function getGlobalWordCloud(params) {
  return request({
    url: '/stat/goods/wordcloud/global',
    method: 'get',
    params: params
  })
}
```

## 技术风险评估

### 低风险
- 数据库查询优化，使用索引
- 分词算法改进，提高准确性
- 接口兼容性保持

### 中风险
- 大量评论数据处理可能影响性能
- 需要确保分类过滤的准确性

### 缓解措施
- 添加查询限制（如最多1000条评论）
- 使用缓存机制减少重复计算
- 添加日志监控性能指标

## 测试方案

### 1. 功能测试
- 验证全局词云是否正常显示
- 验证分类筛选功能是否正常
- 验证词云数据是否正确（生成的是词语而非句子）

### 2. 性能测试
- 测试大量评论数据的处理性能
- 测试不同分类下的查询性能

### 3. 兼容性测试
- 确保原有接口仍然可用
- 确保前端页面正常显示

## 实施步骤

1. **第一步**：修改数据库层，新增查询方法
2. **第二步**：优化WordCloudService分词算法
3. **第三步**：新增全局词云接口
4. **第四步**：修改前端，移除单个商品词云功能
5. **第五步**：测试验证，确保功能正常