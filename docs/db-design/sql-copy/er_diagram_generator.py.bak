#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å¢å¼ºç‰ˆE-Rå›¾ç”Ÿæˆå™¨ - æ”¯æŒè§£ææ‰€æœ‰è¡¨å’Œå¤–é”®å…³ç³»
"""

import re
import os

def extract_all_tables(sql_content):
    """æå–SQLæ–‡ä»¶ä¸­æ‰€æœ‰çš„è¡¨å"""
    table_pattern = r'CREATE TABLE `([^`]+)`'
    tables = re.findall(table_pattern, sql_content)
    return tables

def parse_table_enhanced(sql_content: str, target_table: str):
    """å¢å¼ºç‰ˆè¡¨ç»“æ„è§£æ - æ”¯æŒå¤–é”®è¯†åˆ«"""
    # æŸ¥æ‰¾ç›®æ ‡è¡¨çš„CREATE TABLEè¯­å¥
    table_pattern = rf'CREATE TABLE `{re.escape(target_table)}`\s*\((.*?)ENGINE'
    table_match = re.search(table_pattern, sql_content, re.DOTALL)
    
    if not table_match:
        print(f"æœªæ‰¾åˆ°è¡¨ {target_table}")
        return None
    
    table_definition = table_match.group(0)
    
    # æŸ¥æ‰¾è¡¨æ³¨é‡Š
    comment_match = re.search(r"COMMENT\s*'([^']+)'", table_definition)
    comment = comment_match.group(1) if comment_match else ""
    
    table_info = {
        'name': target_table,
        'comment': comment,
        'columns': [],
        'primary_keys': [],
        'foreign_keys': [],
        'indexes': []
    }
    
    # æå–åˆ—å®šä¹‰éƒ¨åˆ†ï¼ˆæ‹¬å·å†…çš„å†…å®¹ï¼‰
    # æ‰¾åˆ°ç¬¬ä¸€ä¸ªå·¦æ‹¬å·å’Œæœ€åä¸€ä¸ªå³æ‹¬å·
    brace_start = table_definition.find('(')
    brace_end = table_definition.rfind(')')
    
    if brace_start == -1 or brace_end == -1:
        print(f"æœªæ‰¾åˆ°è¡¨ {target_table} çš„åˆ—å®šä¹‰èŒƒå›´")
        return None
    
    column_section = table_definition[brace_start + 1:brace_end]
    
    # æŒ‰è¡Œåˆ†å‰²åˆ—å®šä¹‰
    lines = [line.strip() for line in column_section.split('\n') if line.strip()]
    
    for line in lines:
        # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
        if not line or line.startswith('--'):
            continue
            
        # è§£æåˆ—å®šä¹‰
        if line.startswith('`'):
            # è§£æåˆ—å®šä¹‰ - æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼
            column_match = re.match(r'`(\w+)`\s+([^,]+?)(?:,\s*)?(?:--.*)?$', line.strip())
            if column_match:
                column_name = column_match.group(1)
                column_def = column_match.group(2).strip()
                
                # æå–æ•°æ®ç±»å‹
                type_match = re.match(r'(\w+(?:\([^)]+\))?)\s*(.*)', column_def)
                if type_match:
                    column_type = type_match.group(1)
                    constraints = type_match.group(2)
                else:
                    column_type = column_def
                    constraints = ""
                
                # æå–æ³¨é‡Š
                comment_match = re.search(r"COMMENT\s*'([^']+)'", line)
                column_comment = comment_match.group(1) if comment_match else ""
                
                # æ£€æŸ¥æ˜¯å¦ä¸ºä¸»é”®
                is_primary = 'PRIMARY KEY' in line or 'AUTO_INCREMENT' in column_def
                is_not_null = 'NOT NULL' in column_def
                has_default = 'DEFAULT' in column_def
                
                # æ£€æŸ¥å¤–é”®çº¦æŸ
                is_foreign_key = False
                referenced_table = None
                referenced_column = None
                
                # æŸ¥æ‰¾å¤–é”®å¼•ç”¨ï¼ˆé€šè¿‡KEYå’ŒFOREIGN KEYï¼‰
                if 'KEY' in line and not 'PRIMARY KEY' in line:
                    # è¿™å¯èƒ½æ˜¯å¤–é”®ç´¢å¼•
                    key_match = re.search(r'KEY\s+`?(\w+)`?\s*\(`(\w+)`\)', line)
                    if key_match and key_match.group(2) == column_name:
                        # è®°å½•ç´¢å¼•ä¿¡æ¯ï¼Œåç»­å¯èƒ½å…³è”åˆ°å¤–é”®
                        table_info['indexes'].append({
                            'name': key_match.group(1),
                            'column': column_name
                        })
                
                column_info = {
                    'name': column_name,
                    'type': column_type,
                    'comment': column_comment,
                    'is_primary': is_primary,
                    'is_not_null': is_not_null,
                    'has_default': has_default,
                    'is_foreign_key': is_foreign_key,
                    'referenced_table': referenced_table,
                    'referenced_column': referenced_column
                }
                
                table_info['columns'].append(column_info)
                
                if is_primary:
                    table_info['primary_keys'].append(column_name)
        
        # è§£æè¡¨çº§çº¦æŸï¼ˆä¸»é”®ã€å¤–é”®ã€å”¯ä¸€é”®ç­‰ï¼‰
        elif 'PRIMARY KEY' in line and '(`' in line:
            # è§£æå¤åˆä¸»é”®
            pk_columns = re.findall(r'`([^`]+)`', line)
            for col in pk_columns:
                if col not in table_info['primary_keys']:
                    table_info['primary_keys'].append(col)
        
        elif 'KEY' in line and not 'PRIMARY KEY' in line:
            # è§£æç´¢å¼•
            key_match = re.search(r'(?:KEY|INDEX)\s+`?(\w+)`?\s*\(([^)]+)\)', line)
            if key_match:
                key_name = key_match.group(1)
                key_columns = re.findall(r'`([^`]+)`', key_match.group(2))
                table_info['indexes'].append({
                    'name': key_name,
                    'columns': key_columns
                })
    
    # åŸºäºåˆ—åå’Œç´¢å¼•æ¨æ–­å¤–é”®å…³ç³»
    infer_foreign_keys(table_info, sql_content)
    
    return table_info

def infer_foreign_keys(table_info, sql_content):
    """åŸºäºåˆ—åå’Œç´¢å¼•æ¨æ–­å¤–é”®å…³ç³»"""
    foreign_key_patterns = [
        (r'(\w+)_id$', 'user', 'id'),
        (r'(\w+)_id$', 'goods', 'id'),
        (r'(\w+)_id$', 'order', 'id'),
        (r'(\w+)_id$', 'category', 'id'),
        (r'(\w+)_id$', 'brand', 'id'),
        (r'(\w+)_id$', 'coupon', 'id'),
        (r'parent_(\w+)_id$', 'category', 'id'),
        (r'(\w+)_sn$', 'goods', 'goods_sn'),
    ]
    
    for column in table_info['columns']:
        if column['name'].endswith('_id') or column['name'].endswith('_sn'):
            for pattern, ref_table, ref_column in foreign_key_patterns:
                if re.match(pattern, column['name']):
                    # æ£€æŸ¥å¼•ç”¨çš„è¡¨æ˜¯å¦å­˜åœ¨
                    if f'`{ref_table}`' in sql_content:
                        column['is_foreign_key'] = True
                        column['referenced_table'] = ref_table
                        column['referenced_column'] = ref_column
                        
                        table_info['foreign_keys'].append({
                            'column': column['name'],
                            'referenced_table': ref_table,
                            'referenced_column': ref_column
                        })
                        break

def generate_mermaid_diagram_simple(table_info):
    """ç”ŸæˆMermaidæ ¼å¼çš„E-Rå›¾"""
    if not table_info or not table_info['columns']:
        return ""
    
    mermaid_code = f"""erDiagram
    {table_info['name']} {{"""
    
    for col in table_info['columns']:
        # ç®€åŒ–æ•°æ®ç±»å‹æ˜¾ç¤º
        simple_type = col['type'].split('(')[0] if '(' in col['type'] else col['type']
        
        # æ·»åŠ ä¸»é”®æ ‡è®°
        pk_indicator = " PK" if col['is_primary'] else ""
        
        mermaid_code += f"\n        {col['name']} {simple_type}{pk_indicator}"
    
    mermaid_code += "\n    }"
    
    return mermaid_code

def generate_dbml_diagram_simple(table_info):
    """ç”ŸæˆDBMLæ ¼å¼çš„E-Rå›¾"""
    if not table_info or not table_info['columns']:
        return ""
    
    dbml_code = f"""Table {table_info['name']} {{"""
    
    for col in table_info['columns']:
        # è½¬æ¢æ•°æ®ç±»å‹
        dbml_type = convert_to_dbml_type_simple(col['type'])
        
        # æ·»åŠ çº¦æŸ
        constraints = []
        if col['is_primary']:
            constraints.append("primary key")
        
        constraint_str = ""
        if constraints:
            constraint_str = f" [{', '.join(constraints)}]"
        
        # æ·»åŠ æ³¨é‡Š
        comment_str = ""
        if col['comment']:
            comment_str = f" [note: '{col['comment']}']"
        
        dbml_code += f"\n  {col['name']} {dbml_type}{constraint_str}{comment_str}"
    
    dbml_code += "\n}"
    
    return dbml_code

def convert_to_dbml_type_simple(mysql_type: str) -> str:
    """å°†MySQLæ•°æ®ç±»å‹è½¬æ¢ä¸ºDBMLç±»å‹"""
    type_mapping = {
        'int': 'integer',
        'tinyint': 'boolean',
        'smallint': 'smallint',
        'varchar': 'varchar',
        'char': 'char',
        'text': 'text',
        'decimal': 'decimal',
        'datetime': 'datetime',
        'date': 'date',
        'time': 'time'
    }
    
    base_type = mysql_type.split('(')[0].lower()
    return type_mapping.get(base_type, 'varchar')

def generate_detailed_text_diagram_simple(table_info):
    """ç”Ÿæˆè¯¦ç»†çš„æ–‡æœ¬æ ¼å¼E-Rå›¾"""
    if not table_info or not table_info['columns']:
        return ""
    
    text_diagram = f"""è¡¨ç»“æ„è¯¦æƒ…: {table_info['name']}
è¡¨æ³¨é‡Š: {table_info['comment']}
æ€»åˆ—æ•°: {len(table_info['columns'])}
ä¸»é”®: {', '.join(table_info['primary_keys']) if table_info['primary_keys'] else 'æ— '}

åˆ—ä¿¡æ¯:
"""
    
    for i, col in enumerate(table_info['columns'], 1):
        primary_indicator = " (ä¸»é”®)" if col['is_primary'] else ""
        comment = f" - {col['comment']}" if col['comment'] else ""
        
        # é™åˆ¶ç±»å‹æ˜¾ç¤ºé•¿åº¦
        type_display = col['type'][:25] + "..." if len(col['type']) > 25 else col['type']
        
        text_diagram += f"{i:2d}. {col['name']:20} {type_display:30}{primary_indicator}{comment}\n"
    
    return text_diagram

def main():
    """ä¸»å‡½æ•°"""
    sql_file_path = "sql-copy/litemall_table.sql"
    
    # æµ‹è¯•è§£æå•ä¸ªè¡¨
    print("æ­£åœ¨ç®€å•è§£æ litemall_ad è¡¨...")
    table_info = parse_table_simple(sql_file_path, "litemall_ad")
    
    if table_info and table_info['columns']:
        print(f"\nâœ… æˆåŠŸè§£æè¡¨: {table_info['name']}")
        print(f"ğŸ“ è¡¨æ³¨é‡Š: {table_info['comment']}")
        print(f"ğŸ”¢ åˆ—æ•°: {len(table_info['columns'])}")
        print(f"ğŸ”‘ ä¸»é”®: {table_info['primary_keys']}")
        
        # æ˜¾ç¤ºå‰å‡ åˆ—ä¿¡æ¯
        print("\nğŸ“‹ å‰5åˆ—ä¿¡æ¯:")
        for i, col in enumerate(table_info['columns'][:5], 1):
            print(f"  {i}. {col['name']} - {col['type']}")
        
        # ç”ŸæˆMermaidæ ¼å¼
        mermaid_diagram = generate_mermaid_diagram_simple(table_info)
        with open("simple_er_diagram.mmd", "w", encoding="utf-8") as f:
            f.write(mermaid_diagram)
        print("\nğŸ“Š å·²ç”ŸæˆMermaidæ ¼å¼E-Rå›¾: simple_er_diagram.mmd")
        
        # ç”ŸæˆDBMLæ ¼å¼
        dbml_diagram = generate_dbml_diagram_simple(table_info)
        with open("simple_er_diagram.dbml", "w", encoding="utf-8") as f:
            f.write(dbml_diagram)
        print("ğŸ“Š å·²ç”ŸæˆDBMLæ ¼å¼E-Rå›¾: simple_er_diagram.dbml")
        
        # ç”Ÿæˆæ–‡æœ¬æ ¼å¼
        text_diagram = generate_detailed_text_diagram_simple(table_info)
        with open("simple_er_diagram.txt", "w", encoding="utf-8") as f:
            f.write(text_diagram)
        print("ğŸ“Š å·²ç”Ÿæˆæ–‡æœ¬æ ¼å¼E-Rå›¾: simple_er_diagram.txt")
        
        # æ˜¾ç¤ºéƒ¨åˆ†å†…å®¹
        print("\n" + "="*60)
        print("ç”Ÿæˆçš„Mermaid E-Rå›¾:")
        print(mermaid_diagram)
        
        print("\n" + "="*60)
        print("ç”Ÿæˆçš„DBML E-Rå›¾:")
        print(dbml_diagram)
        
        print("\n" + "="*60)
        print("ç”Ÿæˆçš„æ–‡æœ¬E-Rå›¾ (å‰10åˆ—):")
        lines = text_diagram.split('\n')
        print('\n'.join(lines[:15]))
        
    else:
        print("âŒ è§£æå¤±è´¥æˆ–æœªæ‰¾åˆ°åˆ—ä¿¡æ¯")

if __name__ == "__main__":
    main()