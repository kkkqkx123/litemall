# litemall 权限注解最佳实践指南

## 概述

本文档定义了在litemall项目中正确使用权限注解的标准和规范，确保系统的安全性和可维护性。

## 权限注解体系

### 三套注解的职责分工

#### 1. @PreAuthorize（Spring Security）
- **职责**：运行时权限验证
- **作用**：在方法调用时验证用户权限，提供安全保障
- **依赖**：Spring Security框架
- **示例**：`@PreAuthorize("hasAuthority('admin:category:list')")`

#### 2. @RequiresPermissions（自定义）
- **职责**：权限菜单管理
- **作用**：为权限管理界面提供数据，支持权限可视化配置
- **依赖**：PermissionUtil扫描机制
- **示例**：`@RequiresPermissions("admin:category:list")`

#### 3. @RequiresPermissionsDesc（自定义）
- **职责**：权限描述信息
- **作用**：提供权限的菜单结构和按钮描述
- **依赖**：与@RequiresPermissions配套使用
- **示例**：`@RequiresPermissionsDesc(menu = {"商品管理", "商品类目"}, button = "查询")`

## 使用规范

### 1. 标准格式

```java
@RestController
@RequestMapping("/admin/category")
public class AdminCategoryController {
    
    @PreAuthorize("hasAuthority('admin:category:list')")
    @RequiresPermissions("admin:category:list")
    @RequiresPermissionsDesc(menu = {"商品管理", "商品类目"}, button = "查询")
    @GetMapping("/list")
    public Object list() {
        // 方法实现
    }
    
    @PreAuthorize("hasAuthority('admin:category:create')")
    @RequiresPermissions("admin:category:create")
    @RequiresPermissionsDesc(menu = {"商品管理", "商品类目"}, button = "添加")
    @PostMapping("/create")
    public Object create(@RequestBody CategoryDTO dto) {
        // 方法实现
    }
    
    @PreAuthorize("hasAuthority('admin:category:read')")
    @RequiresPermissions("admin:category:read")
    @RequiresPermissionsDesc(menu = {"商品管理", "商品类目"}, button = "详情")
    @GetMapping("/read")
    public Object read(@NotNull Integer id) {
        // 方法实现
    }
    
    @PreAuthorize("hasAuthority('admin:category:update')")
    @RequiresPermissions("admin:category:update")
    @RequiresPermissionsDesc(menu = {"商品管理", "商品类目"}, button = "编辑")
    @PostMapping("/update")
    public Object update(@RequestBody CategoryDTO dto) {
        // 方法实现
    }
    
    @PreAuthorize("hasAuthority('admin:category:delete')")
    @RequiresPermissions("admin:category:delete")
    @RequiresPermissionsDesc(menu = {"商品管理", "商品类目"}, button = "删除")
    @PostMapping("/delete")
    public Object delete(@RequestBody CategoryDTO dto) {
        // 方法实现
    }
}
```

### 2. 权限字符串命名规范

#### 标准格式
```
admin:module:action
```

#### 命名规则
- **admin**：固定前缀，表示管理后台权限
- **module**：模块名称，使用小写字母，多个单词用下划线分隔
- **action**：操作类型，使用标准CRUD操作

#### 标准操作类型
| 操作 | 说明 | 示例 |
|------|------|------|
| list | 列表查询 | admin:user:list |
| create | 新增 | admin:user:create |
| read | 详情查看 | admin:user:read |
| update | 编辑更新 | admin:user:update |
| delete | 删除 | admin:user:delete |

### 3. 菜单命名规范

#### 一级菜单（系统模块）
| 菜单名称 | 说明 |
|----------|------|
| 系统管理 | 系统相关配置和管理 |
| 商品管理 | 商品相关的功能模块 |
| 订单管理 | 订单相关的功能模块 |
| 用户管理 | 用户相关的功能模块 |
| 营销管理 | 营销活动相关的功能模块 |
| 统计管理 | 数据统计相关的功能模块 |
| 配置管理 | 系统配置相关的功能模块 |

#### 二级菜单（具体功能）
| 菜单名称 | 说明 |
|----------|------|
| 管理员管理 | 系统管理员账号管理 |
| 角色管理 | 权限角色管理 |
| 商品类目 | 商品分类管理 |
| 商品品牌 | 商品品牌管理 |
| 会员管理 | 系统会员用户管理 |
| 优惠券 | 优惠券管理 |
| 团购管理 | 团购活动管理 |

#### 按钮名称（操作类型）
| 按钮名称 | 说明 |
|----------|------|
| 查询 | 列表查询操作 |
| 添加 | 新增数据操作 |
| 详情 | 查看详情操作 |
| 编辑 | 修改数据操作 |
| 删除 | 删除数据操作 |
| 批量删除 | 批量删除操作 |

## 开发流程规范

### 1. 新增接口的权限注解添加流程

#### 步骤1：确定权限字符串
```
格式：admin:module:action
示例：admin:product:create
```

#### 步骤2：确定菜单结构
```
一级菜单：商品管理
二级菜单：商品列表
按钮名称：添加
```

#### 步骤3：添加权限注解
```java
@PreAuthorize("hasAuthority('admin:product:create')")
@RequiresPermissions("admin:product:create")
@RequiresPermissionsDesc(menu = {"商品管理", "商品列表"}, button = "添加")
```

#### 步骤4：验证权限一致性
- 确保三套注解的权限字符串完全一致
- 检查菜单结构和按钮描述准确
- 测试权限验证功能是否正常

### 2. 代码审查检查清单

#### 权限注解检查
- [ ] @PreAuthorize注解是否存在
- [ ] @RequiresPermissions注解是否存在
- [ ] @RequiresPermissionsDesc注解是否存在
- [ ] 权限字符串是否一致
- [ ] 菜单结构是否合理
- [ ] 按钮描述是否准确

#### 代码质量检查
- [ ] 导入语句是否正确
- [ ] 注解顺序是否规范
- [ ] 权限字符串是否符合命名规范
- [ ] 菜单命名是否符合标准

## 常见问题及解决方案

### 问题1：忘记添加@PreAuthorize注解
**现象**：权限管理界面正常，但接口没有权限验证
**解决方案**：添加对应的@PreAuthorize注解

### 问题2：权限字符串不一致
**现象**：权限管理界面和实际权限验证不匹配
**解决方案**：确保三套注解使用相同的权限字符串

### 问题3：菜单结构不合理
**现象**：权限管理界面显示混乱
**解决方案**：按照标准菜单结构重新组织

### 问题4：缺少导入语句
**现象**：编译错误，找不到@PreAuthorize
**解决方案**：添加导入语句
```java
import org.springframework.security.access.prepost.PreAuthorize;
```

## 工具和建议

### 1. 自动化检查工具
建议开发IDE插件或Maven插件，自动检查：
- 权限注解的完整性
- 权限字符串的一致性
- 菜单结构的合理性

### 2. 代码模板
使用IDE代码模板，快速生成标准的权限注解：
```java
@PreAuthorize("hasAuthority('$PERMISSION$')")
@RequiresPermissions("$PERMISSION$")
@RequiresPermissionsDesc(menu = {"$MENU1$", "$MENU2$"}, button = "$BUTTON$")
```

### 3. 文档维护
- 定期更新权限列表文档
- 维护菜单结构标准
- 记录权限变更历史

## 总结

遵循本指南可以确保：
1. **系统安全性**：所有接口都有适当的权限验证
2. **权限可管理性**：权限管理界面清晰易用
3. **代码一致性**：权限注解使用规范统一
4. **维护便利性**：权限结构清晰，易于维护

通过标准化的权限注解使用，可以大大提高系统的安全性和可维护性。