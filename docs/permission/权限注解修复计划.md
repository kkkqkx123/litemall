# litemall 权限注解修复计划

## 当前状态分析

### 已修复的控制器（同时拥有@PreAuthorize和@RequiresPermissions）
1. **AdminFootprintController** - 完全修复 ✓
2. **AdminCategoryController** - 完全修复 ✓  
3. **AdminBrandController** - 完全修复 ✓
4. **AdminIndexController** - 测试用例，无需修复 ✓
5. **AdminProfileController** - 认证相关，权限较宽松 ✓

### 需要修复的控制器（只有@RequiresPermissions，缺少@PreAuthorize）

#### 高优先级（核心业务功能）
1. **AdminAdController** - 广告管理（5个接口）
2. **AdminGrouponController** - 团购管理（5个接口）
3. **AdminUserController** - 用户管理（3个接口）
4. **AdminNoticeController** - 通知管理（6个接口）
5. **AdminCouponController** - 优惠券管理（6个接口）
6. **AdminStorageController** - 存储管理（5个接口）
7. **AdminAdminController** - 管理员管理（5个接口）
8. **AdminRoleController** - 角色管理（7个接口）

#### 中优先级（统计和配置功能）
9. **AdminStatController** - 统计功能（8个接口）
10. **AdminConfigController** - 配置管理（9个接口）

#### 低优先级（辅助功能）
11. **AdminCollectController** - 收藏管理（1个接口）
12. **AdminLogController** - 日志管理（1个接口）
13. **AdminFeedbackController** - 反馈管理（1个接口）
14. **AdminLLMQAController** - LLM问答（6个接口）

## 修复步骤

### 第一阶段：高优先级核心业务（预计1-2天）
修复广告、团购、用户、通知、优惠券、存储、管理员、角色等核心管理功能

### 第二阶段：中优先级功能（预计1天）
修复统计和配置管理功能

### 第三阶段：低优先级功能（预计0.5天）
修复收藏、日志、反馈等辅助功能

## 修复规范

### 1. 注解格式规范
```java
@PreAuthorize("hasAuthority('admin:module:action')")
@RequiresPermissions("admin:module:action")
@RequiresPermissionsDesc(menu = {"一级菜单", "二级菜单"}, button = "按钮名称")
```

### 2. 权限字符串命名规范
- 格式：`admin:module:action`
- module：使用小写字母，多个单词用下划线分隔
- action：使用标准CRUD操作（list, create, read, update, delete）

### 3. 菜单命名规范
- 一级菜单：使用标准模块名称（商品管理、订单管理、用户管理等）
- 二级菜单：使用具体功能名称（商品类目、商品品牌、商品列表等）
- 按钮名称：使用操作描述（查询、添加、详情、编辑、删除等）

## 质量检查清单

### 修复完成后需要检查的项目：

1. **代码编译检查**
   - [ ] 执行`mvn clean compile`确保无编译错误
   - [ ] 检查导入语句是否正确

2. **权限一致性检查**
   - [ ] @PreAuthorize和@RequiresPermissions的权限字符串一致
   - [ ] @RequiresPermissionsDesc的菜单和按钮描述准确

3. **功能测试检查**
   - [ ] 使用管理员账号测试接口访问
   - [ ] 使用无权限账号测试接口拒绝
   - [ ] 检查权限管理界面是否正常显示

4. **权限管理界面检查**
   - [ ] 角色权限分配界面能正常显示新权限
   - [ ] 权限菜单结构正确

## 风险控制

### 1. 回滚方案
- 每个控制器的修复作为一个独立的提交
- 保留修复前的代码备份
- 出现问题可以快速回滚到指定控制器

### 2. 测试策略
- 优先在测试环境验证修复效果
- 生产环境采用灰度发布策略
- 监控用户反馈和系统日志

### 3. 兼容性保证
- 保持现有的@RequiresPermissions注解不变
- 只添加@PreAuthorize注解，不影响现有功能
- 权限字符串保持与现有数据库一致

## 预期效果

### 修复完成后的改进：
1. **安全性提升**：所有管理接口都有实际的权限验证
2. **权限管理完善**：权限管理界面能正确显示所有权限
3. **用户体验改善**：权限控制更加精确和可靠
4. **系统稳定性**：减少因权限问题导致的安全隐患

### 长期收益：
1. **代码规范统一**：建立标准的权限注解使用规范
2. **维护成本降低**：权限管理更加清晰和易于维护
3. **扩展性增强**：新增功能可以快速添加权限控制
4. **审计能力**：完善的权限日志和审计功能