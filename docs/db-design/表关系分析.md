# Litemall 数据库表关系分析

## 概述
本文档基于 `litemall_table.sql` 文件分析 Litemall 电商系统的数据库表结构关系，包括一对一、一对多、多对多关系以及外键关联。

## 表关系分类

### 一、一对多关系 (One-to-Many)

#### 1. 用户相关关系

**用户 → 收货地址**
- 主表：`litemall_user` (用户表)
- 从表：`litemall_address` (收货地址表)
- 外键：`litemall_address.user_id` → `litemall_user.id`
- 关系描述：一个用户可以有多个收货地址

**用户 → 购物车**
- 主表：`litemall_user` (用户表)
- 从表：`litemall_cart` (购物车表)
- 外键：`litemall_cart.user_id` → `litemall_user.id`
- 关系描述：一个用户可以有多个购物车商品项

**用户 → 收藏记录**
- 主表：`litemall_user` (用户表)
- 从表：`litemall_collect` (收藏表)
- 外键：`litemall_collect.user_id` → `litemall_user.id`
- 关系描述：一个用户可以有多个收藏记录

**用户 → 浏览足迹**
- 主表：`litemall_user` (用户表)
- 从表：`litemall_footprint` (用户浏览足迹表)
- 外键：`litemall_footprint.user_id` → `litemall_user.id`
- 关系描述：一个用户可以有多个浏览记录

**用户 → 搜索历史**
- 主表：`litemall_user` (用户表)
- 从表：`litemall_search_history` (搜索历史表)
- 外键：`litemall_search_history.user_id` → `litemall_user.id`
- 关系描述：一个用户可以有多个搜索历史记录

**用户 → 反馈记录**
- 主表：`litemall_user` (用户表)
- 从表：`litemall_feedback` (意见反馈表)
- 外键：`litemall_feedback.user_id` → `litemall_user.id`
- 关系描述：一个用户可以有多个反馈记录

**用户 → 订单**
- 主表：`litemall_user` (用户表)
- 从表：`litemall_order` (订单表)
- 外键：`litemall_order.user_id` → `litemall_user.id`
- 关系描述：一个用户可以有多个订单

**用户 → 优惠券用户关联**
- 主表：`litemall_user` (用户表)
- 从表：`litemall_coupon_user` (优惠券用户使用表)
- 外键：`litemall_coupon_user.user_id` → `litemall_user.id`
- 关系描述：一个用户可以有多个优惠券

**用户 → 售后记录**
- 主表：`litemall_user` (用户表)
- 从表：`litemall_aftersale` (售后表)
- 外键：`litemall_aftersale.user_id` → `litemall_user.id`
- 关系描述：一个用户可以有多个售后申请

**用户 → 评论**
- 主表：`litemall_user` (用户表)
- 从表：`litemall_comment` (评论表)
- 外键：`litemall_comment.user_id` → `litemall_user.id`
- 关系描述：一个用户可以有多个评论

#### 2. 商品相关关系

**商品分类 → 商品**
- 主表：`litemall_category` (类目表)
- 从表：`litemall_goods` (商品基本信息表)
- 外键：`litemall_goods.category_id` → `litemall_category.id`
- 关系描述：一个分类可以有多个商品

**商品分类 → 子分类**
- 主表：`litemall_category` (类目表)
- 从表：`litemall_category` (类目表自身)
- 外键：`litemall_category.pid` → `litemall_category.id`
- 关系描述：一个父分类可以有多个子分类

**品牌 → 商品**
- 主表：`litemall_brand` (品牌商表)
- 从表：`litemall_goods` (商品基本信息表)
- 外键：`litemall_goods.brand_id` → `litemall_brand.id`
- 关系描述：一个品牌可以有多个商品

**商品 → 商品属性**
- 主表：`litemall_goods` (商品基本信息表)
- 从表：`litemall_goods_attribute` (商品参数表)
- 外键：`litemall_goods_attribute.goods_id` → `litemall_goods.id`
- 关系描述：一个商品可以有多个属性参数

**商品 → 商品规格**
- 主表：`litemall_goods` (商品基本信息表)
- 从表：`litemall_goods_specification` (商品规格表)
- 外键：`litemall_goods_specification.goods_id` → `litemall_goods.id`
- 关系描述：一个商品可以有多个规格

**商品 → 商品货品**
- 主表：`litemall_goods` (商品基本信息表)
- 从表：`litemall_goods_product` (商品货品表)
- 外键：`litemall_goods_product.goods_id` → `litemall_goods.id`
- 关系描述：一个商品可以有多个货品（SKU）

**商品 → 团购规则**
- 主表：`litemall_goods` (商品基本信息表)
- 从表：`litemall_groupon_rules` (团购规则表)
- 外键：`litemall_groupon_rules.goods_id` → `litemall_goods.id`
- 关系描述：一个商品可以有多个团购规则

#### 3. 订单相关关系

**订单 → 订单商品**
- 主表：`litemall_order` (订单表)
- 从表：`litemall_order_goods` (订单商品表)
- 外键：`litemall_order_goods.order_id` → `litemall_order.id`
- 关系描述：一个订单可以包含多个商品

**订单 → 售后记录**
- 主表：`litemall_order` (订单表)
- 从表：`litemall_aftersale` (售后表)
- 外键：`litemall_aftersale.order_id` → `litemall_order.id`
- 关系描述：一个订单可以有多个售后申请

**订单 → 团购活动**
- 主表：`litemall_order` (订单表)
- 从表：`litemall_groupon` (团购活动表)
- 外键：`litemall_groupon.order_id` → `litemall_order.id`
- 关系描述：一个订单可以关联多个团购活动

#### 4. 优惠券相关关系

**优惠券 → 优惠券用户关联**
- 主表：`litemall_coupon` (优惠券信息及规则表)
- 从表：`litemall_coupon_user` (优惠券用户使用表)
- 外键：`litemall_coupon_user.coupon_id` → `litemall_coupon.id`
- 关系描述：一个优惠券可以被多个用户领取

#### 5. 团购相关关系

**团购规则 → 团购活动**
- 主表：`litemall_groupon_rules` (团购规则表)
- 从表：`litemall_groupon` (团购活动表)
- 外键：`litemall_groupon.rules_id` → `litemall_groupon_rules.id`
- 关系描述：一个团购规则可以对应多个团购活动

**团购活动 → 子团购活动**
- 主表：`litemall_groupon` (团购活动表)
- 从表：`litemall_groupon` (团购活动表自身)
- 外键：`litemall_groupon.groupon_id` → `litemall_groupon.id`
- 关系描述：一个主团购活动可以有多个参团的子活动

#### 6. 系统管理相关关系

**管理员 → 通知**
- 主表：`litemall_admin` (管理员表)
- 从表：`litemall_notice` (通知表)
- 外键：`litemall_notice.admin_id` → `litemall_admin.id`
- 关系描述：一个管理员可以创建多个通知

**通知 → 管理员通知关联**
- 主表：`litemall_notice` (通知表)
- 从表：`litemall_notice_admin` (通知管理员表)
- 外键：`litemall_notice_admin.notice_id` → `litemall_notice.id`
- 关系描述：一个通知可以发送给多个管理员

**角色 → 权限**
- 主表：`litemall_role` (角色表)
- 从表：`litemall_permission` (权限表)
- 外键：`litemall_permission.role_id` → `litemall_role.id`
- 关系描述：一个角色可以有多个权限

**行政区域 → 子区域**
- 主表：`litemall_region` (行政区域表)
- 从表：`litemall_region` (行政区域表自身)
- 外键：`litemall_region.pid` → `litemall_region.id`
- 关系描述：一个父区域可以有多个子区域

### 二、多对多关系 (Many-to-Many)

#### 1. 用户与优惠券
**关系描述**：一个用户可以领取多个优惠券，一个优惠券可以被多个用户领取
- 关联表：`litemall_coupon_user` (优惠券用户使用表)
- 相关表：`litemall_user` (用户表) 和 `litemall_coupon` (优惠券表)
- 外键：
  - `litemall_coupon_user.user_id` → `litemall_user.id`
  - `litemall_coupon_user.coupon_id` → `litemall_coupon.id`

#### 2. 用户与商品（收藏关系）
**关系描述**：一个用户可以收藏多个商品，一个商品可以被多个用户收藏
- 关联表：`litemall_collect` (收藏表)
- 相关表：`litemall_user` (用户表) 和 `litemall_goods` (商品表)
- 外键：
  - `litemall_collect.user_id` → `litemall_user.id`
  - `litemall_collect.value_id` → `litemall_goods.id` (当type=0时)

#### 3. 用户与专题（收藏关系）
**关系描述**：一个用户可以收藏多个专题，一个专题可以被多个用户收藏
- 关联表：`litemall_collect` (收藏表)
- 相关表：`litemall_user` (用户表) 和 `litemall_topic` (专题表)
- 外键：
  - `litemall_collect.user_id` → `litemall_user.id`
  - `litemall_collect.value_id` → `litemall_topic.id` (当type=1时)

#### 4. 用户与商品（评论关系）
**关系描述**：一个用户可以对多个商品进行评论，一个商品可以接收多个用户的评论
- 关联表：`litemall_comment` (评论表)
- 相关表：`litemall_user` (用户表) 和 `litemall_goods` (商品表)
- 外键：
  - `litemall_comment.user_id` → `litemall_user.id`
  - `litemall_comment.value_id` → `litemall_goods.id` (当type=0时)

#### 5. 用户与专题（评论关系）
**关系描述**：一个用户可以对多个专题进行评论，一个专题可以接收多个用户的评论
- 关联表：`litemall_comment` (评论表)
- 相关表：`litemall_user` (用户表) 和 `litemall_topic` (专题表)
- 外键：
  - `litemall_comment.user_id` → `litemall_user.id`
  - `litemall_comment.value_id` → `litemall_topic.id` (当type=1时)

#### 6. 管理员与通知
**关系描述**：一个管理员可以接收多个通知，一个通知可以发送给多个管理员
- 关联表：`litemall_notice_admin` (通知管理员表)
- 相关表：`litemall_admin` (管理员表) 和 `litemall_notice` (通知表)
- 外键：
  - `litemall_notice_admin.admin_id` → `litemall_admin.id`
  - `litemall_notice_admin.notice_id` → `litemall_notice.id`

#### 7. 商品与专题
**关系描述**：一个专题可以包含多个商品，一个商品可以属于多个专题
- 关联方式：通过JSON数组字段关联
- 相关表：`litemall_topic` (专题表) 和 `litemall_goods` (商品表)
- 关联字段：`litemall_topic.goods` (JSON数组格式存储商品ID列表)

### 三、一对一关系 (One-to-One)

在Litemall系统中，严格的一对一关系较少，大部分业务场景都使用一对多关系。但以下场景可以视为一对一关系：

#### 1. 订单与团购活动
**关系描述**：一个订单对应一个主团购活动（开团）
- 主表：`litemall_order` (订单表)
- 从表：`litemall_groupon` (团购活动表，groupon_id=0的记录)
- 外键：`litemall_groupon.order_id` → `litemall_order.id`
- 条件：只考虑 `groupon_id = 0` 的主团购活动记录

#### 2. 订单商品与评论
**关系描述**：一个订单商品对应一条评论
- 主表：`litemall_order_goods` (订单商品表)
- 从表：`litemall_comment` (评论表)
- 关联方式：通过字段值关联
- 关联字段：`litemall_order_goods.comment` → `litemall_comment.id`
- 条件：当 `comment > 0` 时

## 外键索引说明

### 已建立的外键索引
1. `litemall_address.user_id` - 用户收货地址关联
2. `litemall_cart.user_id` - 用户购物车关联
3. `litemall_collect.user_id` - 用户收藏关联
4. `litemall_collect.value_id` - 收藏对象关联
5. `litemall_comment.user_id` - 用户评论关联
6. `litemall_comment.value_id` - 评论对象关联
7. `litemall_goods.goods_sn` - 商品编号索引
8. `litemall_goods.category_id` - 商品分类关联
9. `litemall_goods.brand_id` - 商品品牌关联
10. `litemall_goods_attribute.goods_id` - 商品属性关联
11. `litemall_goods_product.goods_id` - 商品货品关联
12. `litemall_goods_specification.goods_id` - 商品规格关联
13. `litemall_groupon_rules.goods_id` - 团购规则商品关联
14. `litemall_order_goods.order_id` - 订单商品关联
15. `litemall_order_goods.goods_id` - 订单商品关联
16. `litemall_category.pid` - 分类层级关联
17. `litemall_region.pid` - 区域层级关联

### 建议补充的外键索引
1. `litemall_address.area_code` - 地区编码索引
2. `litemall_aftersale.order_id` - 售后订单关联
3. `litemall_aftersale.user_id` - 售后用户关联
4. `litemall_coupon_user.user_id` - 优惠券用户关联
5. `litemall_coupon_user.coupon_id` - 优惠券关联
6. `litemall_coupon_user.order_id` - 优惠券订单关联
7. `litemall_footprint.user_id` - 用户足迹关联
8. `litemall_footprint.goods_id` - 商品足迹关联
9. `litemall_groupon.order_id` - 团购订单关联
10. `litemall_groupon.user_id` - 团购用户关联
11. `litemall_groupon.rules_id` - 团购规则关联
12. `litemall_notice_admin.notice_id` - 通知管理员关联
13. `litemall_notice_admin.admin_id` - 管理员通知关联
14. `litemall_order.user_id` - 订单用户关联
15. `litemall_permission.role_id` - 权限角色关联
16. `litemall_search_history.user_id` - 搜索历史用户关联

## 总结

Litemall数据库设计采用了典型的电商系统关系模型：

1. **用户中心**：以用户表为核心，辐射出地址、购物车、订单、收藏等子表
2. **商品中心**：商品表为核心，关联分类、品牌、属性、规格、货品等子表
3. **订单中心**：订单表为核心，关联订单商品、售后、团购等业务
4. **营销系统**：优惠券、团购等活动通过中间表实现多对多关系
5. **权限系统**：管理员、角色、权限通过中间表实现灵活配置

整体架构清晰，符合电商业务逻辑，但在高并发场景下建议补充缺失的外键索引以提升查询性能。